```{r}
#Imports
library(malecns)
library(coconatfly)
library(fafbseg)
library(neuprintr)
library(ggplot2)
library(dplyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(stringr)
library(igraph)
library(tidygraph)
library(ggraph)
library(jsonlite)
library(ggplot2)
library(reshape2)
library(Matrix)
library(ggplot2)
library(ggpubr)

#conna = neuprint_login(dataset='male-cns:v0.9',server='https://neuprint-cns.janelia.org/')
#mcns.rois = neuprint_ROIs(dataset = 'male-cns:v0.9')
#neuprint_get_synapses(13693,roi='VNC')
```

```{r setup, include=FALSE}
# Setup knitr global options for clean rendering and consistent figures
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center',
  fig.width = 8,
  fig.height = 6
)
```


## 1 Load data

### 1.1 Load male boday annotations
```{r}
synapse_threshold=5
mba<-mcns_body_annotations()
mba.static<-mcns_body_annotations()
mba<-mba%>%mutate(type=ifelse(type=='',NA,type))


ppk23.types <- mba%>%filter(receptor_type=='putative_ppk23')%>%pull(type)%>%unique()
ppk25.types <- mba%>%filter(receptor_type=='putative_ppk25')%>%pull(type)%>%unique()
IR52a.types <- mba%>%filter(receptor_type=='putative_IR52a')%>%pull(type)%>%unique()
IR52b.types <- mba%>%filter(receptor_type=='putative_IR52b')%>%pull(type)%>%unique()

mba.dimorphism <- mba %>%
  count(type, dimorphism) %>%
  group_by(type) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(type, dimorphism)
```






### 1.2 Function to load connectivity
```{r}
fetch_connectivity <- function(synapse_threshold = 5) {
  mba <- mcns_body_annotations()%>%
    mutate(type=coalesce(type,flywire_type,manc_type,hemibrain_type))%>%
    mutate(cachero.type = str_extract(synonyms, "(?<=Cachero 2010:)[^;]+") %>%
                            str_trim())
  connectivity <- cf_partners(cf_ids(malecns = mba %>% pull(bodyid)),
                              partners = 'o',
                              threshold = synapse_threshold)
  connectivity <- connectivity %>%
    left_join(mba %>%
                select("type", "bodyid",'fru_dsx','consensus_nt','flywire_type','synonyms','receptor_type','cachero.type','dimorphism') %>%
                mutate(bodyid=as.integer(bodyid))%>%
                rename(pre_type = type,pre_fru_dsx=fru_dsx,pre_nt=consensus_nt,pre_fw_type=flywire_type,pre_synonyms=synonyms,pre_receptor_type=receptor_type,pre.dimorphism=dimorphism,pre.cachero.type=cachero.type),
              by = c('pre_id'='bodyid'))%>%
    rename(post_type = type)%>%
    left_join(mba %>%
                select("bodyid",'fru_dsx','consensus_nt','flywire_type','synonyms','receptor_type','cachero.type','dimorphism') %>%
                mutate(bodyid=as.integer(bodyid))%>%
                rename(post_fru_dsx=fru_dsx,post_nt=consensus_nt,post_fw_type=flywire_type,post_synonyms=synonyms,post_receptor_type=receptor_type,post.dimorphism=dimorphism,post.cachero.type=cachero.type),
              by = c('post_id'='bodyid'))
  return(connectivity)
}
```

### 1.3 Load connectivity
```{r}
conn <-fetch_connectivity()
conn_save <- conn

conn <- conn %>%
  mutate(
    pre_type = case_when(
      grepl("putative_ppk23", pre_receptor_type) ~ "m-cell",
      grepl("putative_ppk25", pre_receptor_type) ~ "f-cell",
      TRUE ~ pre_type
    ),
    post_type = case_when(
      grepl("putative_ppk23", post_receptor_type) ~ "m-cell",
      grepl("putative_ppk25", post_receptor_type) ~ "f-cell",
      TRUE ~ post_type
    )
  )
```

## 2 Adjacency matrix
### 2.1 Function adjacency matrix
```{r}
calculate_normed_adj_matrix <-function(connectivity,cell.or.type='type',pre.or.post='pre'){
  colScale <- function(A, na.rm = TRUE) {
    scalefac <- 1 / Matrix::colSums(A)
    if (na.rm) scalefac[!is.finite(scalefac)] <- 0
    B <- A %*% Matrix::Diagonal(x = scalefac)
    B
    }
  rowScale <- function(A, na.rm = TRUE) {
    scalefac <- 1 / Matrix::rowSums(A)
    if (na.rm) scalefac[!is.finite(scalefac)] <- 0
    B <- Matrix::Diagonal(x = scalefac) %*% A
    B
    }
  if(cell.or.type=='cell'){
    unique.identifier <- union(as.character(connectivity$pre_id), as.character(connectivity$post_id))
    adj.matrix <- sparseMatrix(
      i = match(connectivity$pre_id, unique.identifier),
      j = match(connectivity$post_id, unique.identifier),
      x = connectivity$weight,
      dims = c(length(unique.identifier), length(unique.identifier)),
      dimnames = list(unique.identifier, unique.identifier))
  }else{
    unique.identifier <- union(connectivity$pre_type, connectivity$post_type)
    adj.matrix <- sparseMatrix(
      i = match(connectivity$pre_type, unique.identifier),
      j = match(connectivity$post_type, unique.identifier),
      x = connectivity$weight,
      dims = c(length(unique.identifier), length(unique.identifier)),
      dimnames = list(unique.identifier, unique.identifier))
  }
  if(pre.or.post=='pre'){
    adj.matrix.normed.pre <- rowScale(adj.matrix)
    colnames(adj.matrix.normed.pre) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.pre) <- rownames(adj.matrix)
    return(adj.matrix.normed.pre)
  }else if(pre.or.post=='avg'){
    adj.matrix.normed.post <- colScale(adj.matrix)
    colnames(adj.matrix.normed.post) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.post) <- rownames(adj.matrix)
    adj.matrix.normed.pre <- rowScale(adj.matrix)
    colnames(adj.matrix.normed.pre) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.pre) <- rownames(adj.matrix)
    
    return(avg_mat <- (adj.matrix.normed.post + adj.matrix.normed.post) / 2)
    
  }
  
  else{
    adj.matrix.normed.post <- colScale(adj.matrix)
    colnames(adj.matrix.normed.post) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.post) <- rownames(adj.matrix)
    return(adj.matrix.normed.post)
  }
}
```

### 2.1 Create adjacency matrix
```{r}
use.clone <- F
conn<-conn_save
conn<- conn%>%
  mutate(pre_type=coalesce(pre_type,pre_fw_type),post_type=coalesce(post_type,post_fw_type))%>%
  mutate(pre_type=if_else(is.na(pre_type),as.character(bodyid),pre_type),
         post_type=if_else(is.na(post_type),as.character(partner),post_type))%>%
  mutate(pre_type = gsub("[()]", "", pre_type))%>%
  mutate(post_type = gsub("[()]", "", post_type))




#nam <-calculate_normed_adj_matrix(conn.wo.gaba,cell.or.type='type',pre.or.post='avg') #avg
nam <-calculate_normed_adj_matrix(conn,cell.or.type='type',pre.or.post='post') #avg
nam_thresholded <-nam

g.prout.mcns <- graph_from_adjacency_matrix(
  nam_thresholded,
  mode = "directed",
  weighted = TRUE,
  diag = FALSE
)
```

#Examples vAB3 (11998)
```{r}

  inputs.11998 <- mcns_connection_table(11998,partners='inputs')
  inputs.11998.sum <- inputs.11998%>%group_by(type)%>%summarize(weight=sum(weight))
  inputs.11998.sum$post.input.normed <- inputs.11998.sum$weight/sum(inputs.11998$weight)
  inputs.11998.sum<- inputs.11998.sum %>%
    rename(pre=type)%>%
    mutate(IR52b = pre %in% IR52b.types,
          IR52a = pre %in% IR52a.types,
          ppk25 = pre %in% ppk25.types,
          ppk23 = pre %in% ppk23.types,
          post='vAB3 (11998)') %>% 
    
    left_join(mba.dimorphism,by= c('pre'='type'))
  
  outputs.11998 <- mcns_connection_table(11998,partners='outputs')
  outputs.11998.sum <- outputs.11998%>%group_by(type)%>%summarize(weight=sum(weight))
  outputs.11998.sum$post.input.normed <- outputs.11998.sum$weight/sum(inputs.11998$weight)
  outputs.11998.sum<- outputs.11998.sum %>%
    rename(post=type)%>%
    mutate(IR52b = FALSE,
          IR52a = FALSE,
          ppk25 = FALSE,
          ppk23 = FALSE,
          pre='vAB3 (11998)') %>% 
    
    left_join(mba.dimorphism,by= c('post'='type'))
  
  in.and.out.11998 <- rbind(inputs.11998.sum,outputs.11998.sum)
  
```

#Examples PPN1 (11431)
```{r}

  inputs.11431 <- mcns_connection_table(11431,partners='inputs')
  inputs.11431.sum <- inputs.11431%>%group_by(type)%>%summarize(weight=sum(weight))
  inputs.11431.sum$post.input.normed <- inputs.11431.sum$weight/sum(inputs.11998$weight)
  inputs.11431.sum<- inputs.11431.sum %>%
    rename(pre=type)%>%
    mutate(IR52b = pre %in% IR52b.types,
          IR52a = pre %in% IR52a.types,
          ppk25 = pre %in% ppk25.types,
          ppk23 = pre %in% ppk23.types,
          post='PPN1 (11431)') %>% 
    left_join(mba.dimorphism,by= c('pre'='type'))
  
  outputs.11431 <- mcns_connection_table(11431,partners='outputs')
  outputs.11431.sum <- outputs.11431%>%group_by(type)%>%summarize(weight=sum(weight))
  outputs.11431.sum$post.input.normed <- outputs.11431.sum$weight/sum(inputs.11998$weight)
  outputs.11431.sum<- outputs.11431.sum %>%
    rename(post=type)%>%
    mutate(IR52b = FALSE,
          IR52a = FALSE,
          ppk25 = FALSE,
          ppk23 = FALSE,
          pre='PPN1 (11431)') %>% 
    left_join(mba.dimorphism,by= c('post'='type'))
  
  in.and.out.11431 <- rbind(inputs.11431.sum,outputs.11431.sum)
  
```

target cells PPN1 and vAB3
```{r}
cutoff=0.1
target.PPN1 <- outputs.11431.sum %>%
    filter(post %in% setdiff(outputs.11431.sum%>%pull(post),outputs.11998.sum%>%pull(post)))%>%
    filter(!grepl('AN',post)) %>% 
    filter(!grepl('IN',post)) %>% 
    filter(weight>=100)%>%pull(post)

target.vAB3 <- outputs.11998.sum %>%
    filter(post %in% setdiff(outputs.11998.sum%>%pull(post),outputs.11431.sum%>%pull(post)))%>%
    filter(weight>=100)%>%
    filter(!grepl('AN',post)) %>% 
    filter(!grepl('IN',post)) %>% 
    pull(post)
```

define kstrongest path function
```{r}
add_valence_flag <- function(df, nt_by_type, is_inhib_by_nt) {
  df %>%
    rowwise() %>%
    mutate(
      # split path and drop endpoint
      nodes = list(setdiff(strsplit(path, " -> ", fixed = TRUE)[[1]], end)),
      # lookup NTs
      nts   = list(unname(nt_by_type[unlist(nodes)])),
      # lookup inhibitory flags
      inhib = list(unname(is_inhib_by_nt[unlist(nts)])),
      # count inhibitors
      n_inhib = sum(unlist(inhib), na.rm = TRUE),
      # convert to +1 / -1
      d = ifelse(n_inhib %% 2 == 0, 1, -1)
    ) %>%
    ungroup()
}



find_k_strongest_paths <- function(
  g,
  starts,
  targets,
  mba,
  n_paths = 3,
  diversity = c("otheredges","othernodes","none"),
  ignore_pattern = NULL  # grepl() pattern; matched node names are excluded (start/target kept),
  
){
  
  type2nt <- mba %>%select(type,consensus_nt)%>%group_by(type)%>%distinct()%>%rename(nt=consensus_nt)
  nt_by_type <- setNames(type2nt$nt, type2nt$type)
  inhibitory_nts <- c("gaba","glycine","histamine")
  all_nts <- unique(type2nt$nt)
  is_inhib_by_nt <- setNames(all_nts %in% inhibitory_nts, all_nts)
    
  diversity <- match.arg(diversity)

  # optional: drop nodes matching ignore_pattern (but never drop starts/targets)
  if (!is.null(ignore_pattern)) {
    drop <- V(g)$name[grepl(ignore_pattern, V(g)$name)]
    keep <- unique(c(starts, targets))
    drop <- setdiff(drop, keep)
    if (length(drop)) g <- igraph::delete_vertices(g, drop)
  }

  # weights â†’ log-costs; guard zeros/NAs
  w <- E(g)$weight
  if (is.null(w)) stop("Edges must have numeric 'weight'.")
  w[!is.finite(w) | w <= 0] <- .Machine$double.eps
  log_w <- -log(w)

  results <- list()
  all_nodes <- character(0)

  for (s in starts) for (t in targets) {
    if (!(s %in% V(g)$name) || !(t %in% V(g)$name)) {
      results[[paste(s,t,sep="->")]] <- list(list(
        start = s, end = t, path = NA_character_, strength = NA_real_, hops = NA_integer_
      ))
      next
    }

    g_tmp <- g
    E(g_tmp)$log_weight <- log_w
    pair_paths <- list()

    for (i in seq_len(n_paths)) {
      sp <- igraph::shortest_paths(
        g_tmp, from = s, to = t,
        weights = E(g_tmp)$log_weight,
        output = "both"
      )
      if (length(sp$vpath[[1]]) == 0) break

      vpath <- sp$vpath[[1]]
      epath <- sp$epath[[1]]

      final_strength <- exp(-sum(E(g_tmp)[epath]$log_weight))
      hops <- length(epath)

      pair_paths[[paste0("path", i)]] <- list(
        start = s,
        end = t,
        path = paste(V(g)[vpath]$name, collapse = " -> "),
        strength = final_strength,
        hops = hops
      )

      all_nodes <- c(all_nodes, V(g)[vpath]$name)

      if (diversity == "othernodes") {
        inter <- setdiff(V(g)[vpath]$name, c(s, t))
        if (length(inter)) g_tmp <- igraph::delete_vertices(g_tmp, inter)
      } else if (diversity == "otheredges") {
        g_tmp <- igraph::delete_edges(g_tmp, epath)
      }
    }

    if (length(pair_paths) == 0) {
      pair_paths <- list(list(
        start = s, end = t, path = NA_character_, strength = NA_real_, hops = NA_integer_
      ))
    }

    results[[paste(s,t,sep="->")]] <- pair_paths
  }

  # flatten
  results_df <- do.call(rbind, lapply(results, function(pl) {
    do.call(rbind, lapply(pl, function(r)
      data.frame(start=r$start, end=r$end, path=r$path,
                 strength=r$strength, hops=r$hops,
                 stringsAsFactors=FALSE)))
  }))

  results_df_wo_na <- dplyr::filter(results_df, !is.na(strength))
  all_nodes <- unique(all_nodes)
  
  results_df_wo_na= add_valence_flag(results_df_wo_na, nt_by_type, is_inhib_by_nt)%>%
              mutate(valence = ifelse(d == 1L, "excitatory", "inhibitory"))
  
  list(df = results_df_wo_na, nodes = all_nodes, raw = results)
}

```




path finding new


```{r}
#olfactory
start.types.olf <- c('ORN_DA1','ORN_VA1v')
#start.types.olf <- mba.static%>%filter(grepl('cb_sensory',superclass))%>%filter(grepl('olfactory',class))%>%pull(type)%>%unique()
res.vAB3.olf <- find_k_strongest_paths(g.prout.mcns, starts=start.types.olf, targets=target.vAB3 ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.olf <- find_k_strongest_paths(g.prout.mcns, starts=start.types.olf, targets=target.PPN1,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.olf$df$dataset <- "vAB3"
res.PPN1.olf$df$dataset <- "PPN1"
df_all.single.olf <- bind_rows(res.vAB3.olf$df, res.PPN1.olf$df)



t_res  <- t.test(strength ~ dataset, data = df_all.single.olf)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.single.olf$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.single.olf, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength Olfactory 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.single.olf, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path Olfactory 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.single.olf %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.single.olf, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (olfactory) by valence 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)

```
auditory
```{r}

#auditory
start.types.aud <- mba.static%>%filter(grepl('cb_sensory',superclass))%>%filter(grepl('auditory',subclass))%>%pull(type)%>%unique()
res.vAB3.aud <- find_k_strongest_paths(g.prout.mcns, starts=start.types.aud, targets=target.vAB3 ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.aud <- find_k_strongest_paths(g.prout.mcns, starts=start.types.aud, targets=target.PPN1,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.aud$df$dataset <- "vAB3"
res.PPN1.aud$df$dataset <- "PPN1"
df_all.single.aud <- bind_rows(res.vAB3.aud$df, res.PPN1.aud$df)



t_res  <- t.test(strength ~ dataset, data = df_all.single.aud)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.single.aud$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.single.aud, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength auditory 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.single.aud, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path auditory 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.single.aud %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.single.aud, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (auditory) by valence 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)

```



```{r}
#visual
start.types.vis <- mba%>%filter(superclass=='ol_sensory')%>%pull(type)%>%unique()
res.vAB3.vis <- find_k_strongest_paths(g.prout.mcns, starts=start.types.vis, targets=target.vAB3 ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.vis <- find_k_strongest_paths(g.prout.mcns, starts=start.types.vis, targets=target.PPN1,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.vis$df$dataset <- "vAB3"
res.PPN1.vis$df$dataset <- "PPN1"
df_all.single.vis <- bind_rows(res.vAB3.vis$df, res.PPN1.vis$df)



t_res  <- t.test(strength ~ dataset, data = df_all.single.vis)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.single.vis$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.single.vis, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength Visual 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.single.vis, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path Visual 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.single.vis %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.single.vis, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (visual) by valence 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```


```{r}


#contact chemosensor ppk23

start.types.ppk23 <- mba.static%>%filter(grepl('ppk23',receptor_type))%>%pull(type)%>%unique()
res.vAB3.ppk23 <- find_k_strongest_paths(g.prout.mcns,
                                         starts=start.types.ppk23,
                                         targets=target.vAB3,
                                         n_paths=3,
                                         diversity='otheredges',
                                         ignore_pattern='AN09B017',
                                         mba=mba)
res.PPN1.ppk23 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.PPN1,n_paths=3,diversity='otheredges',ignore_pattern='AN05B102',mba=mba)
res.vAB3.ppk23.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.vAB3 ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.ppk23.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.PPN1,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.ppk23$df$dataset <- "vAB3"
res.PPN1.ppk23$df$dataset <- "PPN1"
res.vAB3.ppk23.include$df$dataset <- "vAB3"
res.PPN1.ppk23.include$df$dataset <- "PPN1"
df_all.single.ppk23 <- bind_rows(res.vAB3.ppk23$df, res.PPN1.ppk23$df)
df_all.single.ppk23.include <- bind_rows(res.vAB3.ppk23.include$df, res.PPN1.ppk23.include$df)


t_res  <- t.test(strength ~ dataset, data = df_all.single.ppk23)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.single.ppk23$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.single.ppk23, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength PPK23 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.single.ppk23, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path PPK23 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.single.ppk23 %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valences
ggplot(df_all.single.ppk23, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (PPK23) by valence 11998_11431") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```


```{r}
#contact chemosensor ppk25
start.types.ppk25 <- mba.static%>%filter(grepl('ppk25',receptor_type))%>%pull(type)%>%unique()
res.vAB3.ppk25 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.vAB3 ,n_paths=3,diversity='otheredges',ignore_pattern='AN09B017',mba=mba)
res.PPN1.ppk25 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.PPN1,n_paths=3,diversity='otheredges',ignore_pattern='AN05B102',mba=mba)
res.vAB3.ppk25.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.vAB3 ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.ppk25.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.PPN1,n_paths=3,diversity='otheredges',mba=mba)


res.vAB3.ppk25$df$dataset <- "vAB3"
res.PPN1.ppk25$df$dataset <- "PPN1"
res.vAB3.ppk25.include$df$dataset <- "vAB3"
res.PPN1.ppk25.include$df$dataset <- "PPN1"
df_all.single.ppk25 <- bind_rows(res.vAB3.ppk25$df, res.PPN1.ppk25$df)
df_all.single.ppk25.include <- bind_rows(res.vAB3.ppk25.include$df, res.PPN1.ppk25.include$df)


t_res  <- t.test(strength ~ dataset, data = df_all.single.ppk25)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.single.ppk25$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.single.ppk25, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength ppk25") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.single.ppk25, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path ppk25") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.single.ppk25 %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.single.ppk25, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (ppk25) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```

All Neurons downstream

```{r}

all.PPN1.ids <- mba%>%filter(grepl('PPN1',synonyms))%>%pull(bodyid)
all.vAB3.ids <- mba%>%filter(grepl('vAB3 Clowney',notes))%>%pull(bodyid)
target.vAB3.all <- cf_partner_summary(cf_ids(malecns=all.vAB3.ids),partners='out',normalise = F) %>% 
  group_by(type.post)%>%
  summarize(weight=sum(weight))%>%
  filter(!grepl('AN',type.post)) %>% 
  filter(!grepl('IN',type.post)) %>%
  arrange(desc(weight)) %>%
  head(10)%>%
  pull(type.post)

target.PPN1.all <- cf_partner_summary(cf_ids(malecns=all.PPN1.ids),partners='out',normalise = F) %>% 
  group_by(type.post)%>%
  summarize(weight=sum(weight))%>%
  filter(!grepl('AN',type.post)) %>% 
  filter(!grepl('IN',type.post)) %>%
  arrange(desc(weight)) %>%
  head(10)%>%
  pull(type.post)




start.types.olf <- c('ORN_DA1','ORN_VA1v')
#start.types.olf <- mba.static%>%filter(grepl('cb_sensory',superclass))%>%filter(grepl('olfactory',class))%>%pull(type)%>%unique()
res.vAB3.olf <- find_k_strongest_paths(g.prout.mcns, starts=start.types.olf, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.olf <- find_k_strongest_paths(g.prout.mcns, starts=start.types.olf, targets=target.PPN1.all,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.olf$df$dataset <- "vAB3"
res.PPN1.olf$df$dataset <- "PPN1"
df_all.all.olf <- bind_rows(res.vAB3.olf$df, res.PPN1.olf$df)



t_res  <- t.test(strength ~ dataset, data = df_all.all.olf)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.olf$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.olf, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength Olfactory") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.all.olf, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path Olfactory") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.all.olf %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.olf, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (olfactory) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)


```

auditory
```{r}

#auditory
start.types.aud <- mba.static%>%filter(grepl('cb_sensory',superclass))%>%filter(grepl('auditory',subclass))%>%pull(type)%>%unique()
res.vAB3.aud <- find_k_strongest_paths(g.prout.mcns, starts=start.types.aud, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.aud <- find_k_strongest_paths(g.prout.mcns, starts=start.types.aud, targets=target.PPN1.all,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.aud$df$dataset <- "vAB3"
res.PPN1.aud$df$dataset <- "PPN1"
df_all.all.aud <- bind_rows(res.vAB3.aud$df, res.PPN1.aud$df)



t_res  <- t.test(strength ~ dataset, data = df_all.all.aud)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.aud$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.aud, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength auditory") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.all.aud, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path auditory") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.all.aud %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.aud, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (auditory) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)

```


```{r}
#visual
start.types.vis <- mba%>%filter(superclass=='ol_sensory')%>%pull(type)%>%unique()
res.vAB3.vis <- find_k_strongest_paths(g.prout.mcns, starts=start.types.vis, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.vis <- find_k_strongest_paths(g.prout.mcns, starts=start.types.vis, targets=target.PPN1.all,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.vis$df$dataset <- "vAB3"
res.PPN1.vis$df$dataset <- "PPN1"
df_all.all.vis <- bind_rows(res.vAB3.vis$df, res.PPN1.vis$df)



t_res  <- t.test(strength ~ dataset, data = df_all.all.vis)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.vis$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.vis, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength Visual") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.all.vis, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path Visual") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.all.vis %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.vis, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (visual) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)

```

```{r}


#contact chemosensor ppk23

start.types.ppk23 <- mba.static%>%filter(grepl('ppk23',receptor_type))%>%pull(type)%>%unique()
res.vAB3.ppk23 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',ignore_pattern='AN09B017',mba=mba)
res.PPN1.ppk23 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.PPN1.all,n_paths=3,diversity='otheredges',ignore_pattern='AN05B102',mba=mba)
res.vAB3.ppk23.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.ppk23.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk23, targets=target.PPN1.all,n_paths=3,diversity='otheredges',mba=mba)

res.vAB3.ppk23$df$dataset <- "vAB3"
res.PPN1.ppk23$df$dataset <- "PPN1"
res.vAB3.ppk23.include$df$dataset <- "vAB3"
res.PPN1.ppk23.include$df$dataset <- "PPN1"
df_all.all.ppk23 <- bind_rows(res.vAB3.ppk23$df, res.PPN1.ppk23$df)
df_all.all.ppk23.include <- bind_rows(res.vAB3.ppk23.include$df, res.PPN1.ppk23.include$df)


t_res  <- t.test(strength ~ dataset, data = df_all.all.ppk23)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.ppk23$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.ppk23, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength PPK23") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.all.ppk23, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path PPK23") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.all.ppk23 %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.ppk23, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (PPK23) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```


```{r}
#contact chemosensor ppk25
start.types.ppk25 <- mba.static%>%filter(grepl('ppk25',receptor_type))%>%pull(type)%>%unique()
res.vAB3.ppk25 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',ignore_pattern='AN09B017',mba=mba)
res.PPN1.ppk25 <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.PPN1.all,n_paths=3,diversity='otheredges',ignore_pattern='AN05B102',mba=mba)
res.vAB3.ppk25.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.vAB3.all ,n_paths=3,diversity='otheredges',mba=mba)
res.PPN1.ppk25.include <- find_k_strongest_paths(g.prout.mcns, starts=start.types.ppk25, targets=target.PPN1.all,n_paths=3,diversity='otheredges',mba=mba)


res.vAB3.ppk25$df$dataset <- "vAB3"
res.PPN1.ppk25$df$dataset <- "PPN1"
res.vAB3.ppk25.include$df$dataset <- "vAB3"
res.PPN1.ppk25.include$df$dataset <- "PPN1"
df_all.all.ppk25 <- bind_rows(res.vAB3.ppk25$df, res.PPN1.ppk25$df)
df_all.all.ppk25.include <- bind_rows(res.vAB3.ppk25.include$df, res.PPN1.ppk25.include$df)


t_res  <- t.test(strength ~ dataset, data = df_all.all.ppk25)
pval   <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.ppk25$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.ppk25, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength ppk25") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p",         # use the column 'p'
    tip.length = 0
  )+
  scale_y_log10() 


ggplot(df_all.all.ppk25, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw()+
  labs(title = "Hops in strongest path ppk25") +
  theme(plot.title = element_text(hjust = 0.5))



ann_strength <- df_all.all.ppk25 %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(strength ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.ppk25, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (ppk25) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~ valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```

Bind all and plot pie diagramms
```{r}
library(dplyr)
library(ggplot2)
library(scales)

# add modality labels (as you already do)
df_all.single.ppk25$modality <- 'female.touch'
df_all.single.ppk23$modality <- 'male.touch'
df_all.single.aud$modality   <- 'auditory'
df_all.single.olf$modality   <- 'olfactory'
df_all.single.vis$modality   <- 'visual'

all.modalities <- rbind(
  df_all.single.ppk25,
  df_all.single.ppk23,
  df_all.single.vis,
  df_all.single.aud,
  df_all.single.olf
)

# helper: build pie data per neuron, optionally filtering by valence
pie_data <- function(df, dataset_name, valence_keep = NULL) {
  df %>%
    filter(dataset == dataset_name) %>%
    { if (!is.null(valence_keep)) filter(., valence %in% valence_keep) else . } %>%
    group_by(end, modality) %>%
    summarise(total_strength = sum(strength, na.rm = TRUE), .groups = "drop_last") %>%
    mutate(prop = total_strength / sum(total_strength)) %>%
    ungroup() %>%
    filter(is.finite(prop))  # drop ends with all-zero strength
}

# helper: plot pies faceted by neuron
pie_plot <- function(pdat, title_txt) {
  ggplot(pdat, aes(x = "", y = prop, fill = modality)) +
    geom_col(width = 1, color = "white") +
    coord_polar(theta = "y") +
    facet_wrap(~ end) +
    theme_void() +
    labs(title = title_txt) +
    geom_text(aes(label = percent(prop, accuracy = 1)),
              position = position_stack(vjust = 0.5), size = 2)
}

## PPN1
ppn1_all <- pie_data(all.modalities, "PPN1", NULL)
ppn1_exc <- pie_data(all.modalities, "PPN1", c("excitatory", 1))     # handles either text or numeric
ppn1_inh <- pie_data(all.modalities, "PPN1", c("inhibitory", -1))

p_ppn1_all <- pie_plot(ppn1_all, "PPN1 (11431): modality contribution per target neuron (all)")
p_ppn1_exc <- pie_plot(ppn1_exc, "PPN1 (11431): modality contribution per target neuron (excitatory only)")
p_ppn1_inh <- pie_plot(ppn1_inh, "PPN1 (11431): modality contribution per target neuron (inhibitory only)")

p_ppn1_all; p_ppn1_exc; p_ppn1_inh

#connected scatter plot

ppn1_all$connection.type <- 'all'
ppn1_exc$connection.type <- 'excitatory'
ppn1_inh$connection.type <- 'inhibitory'

connected.scatterplot.single.ppn1 <- rbind(ppn1_all,ppn1_exc,ppn1_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.single.ppn1, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.single.ppn1$x_pos),
    labels = unique(connected.scatterplot.single.ppn1$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (excluding PPN1) to post PPN1 (11431) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


## vAB3
vab3_all <- pie_data(all.modalities, "vAB3", NULL)
vab3_exc <- pie_data(all.modalities, "vAB3", c("excitatory", 1))
vab3_inh <- pie_data(all.modalities, "vAB3", c("inhibitory", -1))

p_vab3_all <- pie_plot(vab3_all, "vAB3 (11998): modality contribution per target neuron (all)")
p_vab3_exc <- pie_plot(vab3_exc, "vAB3 (11998): modality contribution per target neuron (excitatory only)")
p_vab3_inh <- pie_plot(vab3_inh, "vAB3 (11998): modality contribution per target neuron (inhibitory only) downstream")

p_vab3_all; p_vab3_exc; p_vab3_inh

#connected scatter plot

vab3_all$connection.type <- 'all'
vab3_exc$connection.type <- 'excitatory'
vab3_inh$connection.type <- 'inhibitory'

connected.scatterplot.single.vab3 <- rbind(vab3_all,vab3_exc,vab3_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.single.vab3, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.single.vab3$x_pos),
    labels = unique(connected.scatterplot.single.vab3$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (excluding vAB3) to post vAB3 (11998) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```


```{r}


# add modality labels (as you already do)
df_all.all.ppk25$modality <- 'female.touch'
df_all.all.ppk23$modality <- 'male.touch'
df_all.all.aud$modality   <- 'auditory'
df_all.all.olf$modality   <- 'olfactory'
df_all.all.vis$modality   <- 'visual'

all.modalities <- rbind(
  df_all.all.ppk25,
  df_all.all.ppk23,
  df_all.all.vis,
  df_all.all.aud,
  df_all.all.olf
)

## PPN1
ppn1_all <- pie_data(all.modalities, "PPN1", NULL)
ppn1_exc <- pie_data(all.modalities, "PPN1", c("excitatory", 1))     # handles either text or numeric
ppn1_inh <- pie_data(all.modalities, "PPN1", c("inhibitory", -1))

p_ppn1_all <- pie_plot(ppn1_all, "PPN1: modality contribution per target neuron (all)")
p_ppn1_exc <- pie_plot(ppn1_exc, "PPN1: modality contribution per target neuron (excitatory only)")
p_ppn1_inh <- pie_plot(ppn1_inh, "PPN1: modality contribution per target neuron (inhibitory only)")

p_ppn1_all; p_ppn1_exc; p_ppn1_inh

ppn1_all$connection.type <- 'all'
ppn1_exc$connection.type <- 'excitatory'
ppn1_inh$connection.type <- 'inhibitory'

connected.scatterplot.all.ppn1 <- rbind(ppn1_all,ppn1_exc,ppn1_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.all.ppn1, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.ppn1$x_pos),
    labels = unique(connected.scatterplot.all.ppn1$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (excluding PPN1) to post PPN1 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

## vAB3
vab3_all <- pie_data(all.modalities, "vAB3", NULL)
vab3_exc <- pie_data(all.modalities, "vAB3", c("excitatory", 1))
vab3_inh <- pie_data(all.modalities, "vAB3", c("inhibitory", -1))

p_vab3_all <- pie_plot(vab3_all, "vAB3: modality contribution per target neuron (all)")
p_vab3_exc <- pie_plot(vab3_exc, "vAB3: modality contribution per target neuron (excitatory only)")
p_vab3_inh <- pie_plot(vab3_inh, "vAB3: modality contribution per target neuron (inhibitory only)")


p_vab3_all; p_vab3_exc; p_vab3_inh

#connected scatter plot

vab3_all$connection.type <- 'all'
vab3_exc$connection.type <- 'excitatory'
vab3_inh$connection.type <- 'inhibitory'

connected.scatterplot.all.vab3 <- rbind(vab3_all,vab3_exc,vab3_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.all.vab3, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.vab3$x_pos),
    labels = unique(connected.scatterplot.all.vab3$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (excluding vAB3) to post vAB3 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))



```
Pie diagramms including vAB3/PPN1 in touch 


```{r}
library(dplyr)
library(ggplot2)
library(scales)

# add modality labels (as you already do)
df_all.single.ppk25.include$modality <- 'female.touch'
df_all.single.ppk23.include$modality <- 'male.touch'
df_all.single.aud$modality   <- 'auditory'
df_all.single.olf$modality   <- 'olfactory'
df_all.single.vis$modality   <- 'visual'

all.modalities <- rbind(
  df_all.single.ppk25.include,
  df_all.single.ppk23.include,
  df_all.single.vis,
  df_all.single.aud,
  df_all.single.olf
)

# helper: build pie data per neuron, optionally filtering by valence
pie_data <- function(df, dataset_name, valence_keep = NULL) {
  df %>%
    filter(dataset == dataset_name) %>%
    { if (!is.null(valence_keep)) filter(., valence %in% valence_keep) else . } %>%
    group_by(end, modality) %>%
    summarise(total_strength = sum(strength, na.rm = TRUE), .groups = "drop_last") %>%
    mutate(prop = total_strength / sum(total_strength)) %>%
    ungroup() %>%
    filter(is.finite(prop))  # drop ends with all-zero strength
}

# helper: plot pies faceted by neuron
pie_plot <- function(pdat, title_txt) {
  ggplot(pdat, aes(x = "", y = prop, fill = modality)) +
    geom_col(width = 1, color = "white") +
    coord_polar(theta = "y") +
    facet_wrap(~ end) +
    theme_void() +
    labs(title = title_txt) +
    geom_text(aes(label = percent(prop, accuracy = 1)),
              position = position_stack(vjust = 0.5), size = 2)
}

## PPN1
ppn1_all <- pie_data(all.modalities, "PPN1", NULL)
ppn1_exc <- pie_data(all.modalities, "PPN1", c("excitatory", 1))     # handles either text or numeric
ppn1_inh <- pie_data(all.modalities, "PPN1", c("inhibitory", -1))

p_ppn1_all <- pie_plot(ppn1_all, "PPN1 (11431): modality contribution per target neuron (all) Including PPN1")
p_ppn1_exc <- pie_plot(ppn1_exc, "PPN1 (11431): modality contribution per target neuron (excitatory only) Including PPN1")
p_ppn1_inh <- pie_plot(ppn1_inh, "PPN1 (11431): modality contribution per target neuron (inhibitory only) Including PPN1")


p_ppn1_all; p_ppn1_exc; p_ppn1_inh

#connected scatter plot

ppn1_all$connection.type <- 'all'
ppn1_exc$connection.type <- 'excitatory'
ppn1_inh$connection.type <- 'inhibitory'

connected.scatterplot.single.include.ppn1 <- rbind(ppn1_all,ppn1_exc,ppn1_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.single.include.ppn1, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.single.include.ppn1$x_pos),
    labels = unique(connected.scatterplot.single.include.ppn1$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including PPN1) to post PPN1 (11431) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


## vAB3
vab3_all <- pie_data(all.modalities, "vAB3", NULL)
vab3_exc <- pie_data(all.modalities, "vAB3", c("excitatory", 1))
vab3_inh <- pie_data(all.modalities, "vAB3", c("inhibitory", -1))

p_vab3_all <- pie_plot(vab3_all, "vAB3 (11998): modality contribution per target neuron (all) Including vAB3")
p_vab3_exc <- pie_plot(vab3_exc, "vAB3 (11998): modality contribution per target neuron (excitatory only) Including vAB3")
p_vab3_inh <- pie_plot(vab3_inh, "vAB3 (11998): modality contribution per target neuron (inhibitory only) downstream Including vAB3")


p_vab3_all; p_vab3_exc; p_vab3_inh


#connected scatter plot

vab3_all$connection.type <- 'all'
vab3_exc$connection.type <- 'excitatory'
vab3_inh$connection.type <- 'inhibitory'

connected.scatterplot.single.include.vab3 <- rbind(vab3_all,vab3_exc,vab3_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.single.include.vab3, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.single.include.vab3$x_pos),
    labels = unique(connected.scatterplot.single.include.vab3$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including vAB3) to post vAB3 (11998) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))




```


```{r}


# add modality labels (as you already do)
df_all.all.ppk25.include$modality <- 'female.touch'
df_all.all.ppk23.include$modality <- 'male.touch'
df_all.all.aud$modality   <- 'auditory'
df_all.all.olf$modality   <- 'olfactory'
df_all.all.vis$modality   <- 'visual'

all.modalities <- rbind(  
  df_all.all.ppk25.include,
  df_all.all.ppk23.include,
  df_all.all.vis,
  df_all.all.aud,
  df_all.all.olf
)

## PPN1
ppn1_all <- pie_data(all.modalities, "PPN1", NULL)
ppn1_exc <- pie_data(all.modalities, "PPN1", c("excitatory", 1))     # handles either text or numeric
ppn1_inh <- pie_data(all.modalities, "PPN1", c("inhibitory", -1))

p_ppn1_all <- pie_plot(ppn1_all, "PPN1: modality contribution per target neuron (all)")
p_ppn1_exc <- pie_plot(ppn1_exc, "PPN1: modality contribution per target neuron (excitatory only) Including PPN1")
p_ppn1_inh <- pie_plot(ppn1_inh, "PPN1: modality contribution per target neuron (inhibitory only) Including PPN1")

p_ppn1_all; p_ppn1_exc; p_ppn1_inh

ppn1_all$connection.type <- 'all'
ppn1_exc$connection.type <- 'excitatory'
ppn1_inh$connection.type <- 'inhibitory'

connected.scatterplot.all.include.ppn1 <- rbind(ppn1_all,ppn1_exc,ppn1_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.all.include.ppn1, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.include.ppn1$x_pos),
    labels = unique(connected.scatterplot.all.include.ppn1$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including PPN1) to post PPN1 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

df <- connected.scatterplot.all.include.ppn1%>%
  group_by(connection.type,modality)%>%
  summarize(strength=sum(total_strength)) %>%
  group_by(connection.type) %>%
  mutate(prop = strength / sum(strength)) %>%
  ungroup() %>%
  mutate(
    x_pos = as.numeric(factor(modality, levels = unique(modality))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all"        ~  0,
      connection.type == "excitatory" ~  0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(df, aes(x = x_jittered, y = prop, group = modality, color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(df$x_pos),
    labels = unique(df$modality)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including PPN1) to post PPN1 (all) by connection type across neurons",
    x = "Modality",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


## vAB3
vab3_all <- pie_data(all.modalities, "vAB3", NULL)
vab3_exc <- pie_data(all.modalities, "vAB3", c("excitatory", 1))
vab3_inh <- pie_data(all.modalities, "vAB3", c("inhibitory", -1))

p_vab3_all <- pie_plot(vab3_all, "vAB3: modality contribution per target neuron (all)")
p_vab3_exc <- pie_plot(vab3_exc, "vAB3: modality contribution per target neuron (excitatory only) Including vAB3")
p_vab3_inh <- pie_plot(vab3_inh, "vAB3: modality contribution per target neuron (inhibitory only) Including vAB3")

# print any of these:
p_vab3_all; p_vab3_exc; p_vab3_inh

#connected scatter plot

vab3_all$connection.type <- 'all'
vab3_exc$connection.type <- 'excitatory'
vab3_inh$connection.type <- 'inhibitory'

connected.scatterplot.all.include.vab3 <- rbind(vab3_all,vab3_exc,vab3_inh)%>%
                          mutate(
                            x_pos = as.numeric(factor(end, levels = unique(end))),
                            x_shift = case_when(
                              connection.type == "inhibitory" ~ -0.2,
                              connection.type == "all" ~ 0,
                              connection.type == "excitatory" ~ 0.2
                            ),
                            x_jittered = x_pos + x_shift
                          )

ggplot(connected.scatterplot.all.include.vab3, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +    # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.include.vab3$x_pos),
    labels = unique(connected.scatterplot.all.include.vab3$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including vAB3) to post vAB3 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


df <- connected.scatterplot.all.include.vab3%>%
  group_by(connection.type,modality)%>%
  summarize(strength=sum(total_strength)) %>%
  group_by(connection.type) %>%
  mutate(prop = strength / sum(strength)) %>%
  ungroup() %>%
  mutate(
    x_pos = as.numeric(factor(modality, levels = unique(modality))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all"        ~  0,
      connection.type == "excitatory" ~  0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(df, aes(x = x_jittered, y = prop, group = modality, color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(df$x_pos),
    labels = unique(df$modality)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including vAB3) to post vAB3 (all) by connection type across neurons",
    x = "Modality",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

stacked barplot showing how much the strongest paths from the modalities take of the synapse budget 


```{r}
library(dplyr)
library(stringr)
library(purrr)

end.types.id <- mba %>%filter(type %in% unique(all.modalities.second_last$end) | flywire_type %in% unique(all.modalities.second_last$end))%>%pull(bodyid)

all.modalities.second_last <- all.modalities %>%
  mutate(second_last = map_chr(str_split(path, " -> "), ~ .x[length(.x) - 1]))
aaa <- cf_partner_summary(cf_ids(malecns=end.types.id),partners = "in")%>%
  group_by(type.post) %>%
  mutate(total_weight = sum(weight, na.rm = TRUE)) %>%
  mutate(normed_weight = weight/total_weight) %>% 
  ungroup()

all.modalities.second_last.final <- all.modalities.second_last %>%
  left_join(
    aaa %>% select(type.pre, type.post, normed_weight),
    by = c("second_last" = "type.pre", "end" = "type.post")
  ) %>%
  distinct(second_last, end, .keep_all = TRUE) %>%
  group_by(end) %>%
  summarise(fraction.of.total.input = sum(normed_weight, na.rm = TRUE))
```

test that code is correct
```{r}
FLA001m.in <- cf_partner_summary(cf_ids(malecns=mba %>% 
                                          filter(type == 'CB1119,CB1989') %>% 
                                          pull(bodyid)),partners='in') %>% 
              mutate(norm.weight=weight/sum(weight))
subset <- all.modalities.second_last %>%  filter(end=='CB1119,CB1989') %>%  pull(second_last) %>% unique()

FLA001m.in %>%  filter(type.pre %in% subset) %>%  pull(norm.weight) %>%  sum()
```






