```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.width = 8,
  fig.height = 6
)

# Shared dependencies for strongest-path analyses and visualisations
library(arrow)
library(coconatfly)
library(cowplot)
library(dplyr)
library(fafbseg)
library(ggraph)
library(ggplot2)
library(ggpubr)
library(grid)
library(igraph)
library(jsonlite)
library(malecns)
library(Matrix)
library(neuprintr)
library(nat.ggplot)
library(patchwork)
library(plotly)
library(purrr)
library(RCy3)
library(reshape2)
library(scales)
library(stringr)
library(tidygraph)
library(tidyr)
```

## Overview

This notebook assembles precomputed strongest-path summaries across male and female pheromone circuits, enriches them with morphological annotations, and visualises modality-specific connectivity patterns. Each section builds on the previous one: we begin by loading cached data, derive adjacency matrices and helper utilities, and then profile path strength statistics for different sensory inputs.

## 1 Load data

```{r}
# read precomputed strongest path lookups

df.ppk23.PPN1.include <- read_feather("/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.PPK23.2.PPN1.feather")
df.ppk23.vAB3.include <- read_feather("/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.PPK23.2.vAB3.feather")
df.ppk23.PPN1.include$dataset <- "PPN1"
df.ppk23.vAB3.include$dataset <- "vAB3"


df.ppk25.PPN1.include <- read_feather("/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.PPK25.2.PPN1.feather")
df.ppk25.vAB3.include <- read_feather("/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.PPK25.2.vAB3.feather")
df.ppk25.PPN1.include$dataset <- "PPN1"
df.ppk25.vAB3.include$dataset <- "vAB3"

df_all.all.ppk23.included <- bind_rows(df.ppk23.PPN1.include, df.ppk23.vAB3.include)
df_all.all.ppk25.included <- bind_rows(df.ppk25.PPN1.include, df.ppk25.vAB3.include)
```

#### 1.0.1 Define function that loads a file or alternatively if it doesnt exist exexutes a script
```{r}
load_or_execute <- function(path) {
  if (file.exists(path)) {
    file.exists(path)
    FALSE
  } else {
    TRUE
  }
}
```


### 1.1 Load male body annotations
```{r}
choose_mcns()
synapse_threshold <- 5
if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/mba.feather')) {
  mba <- mcns_body_annotations()
  mba %>% mutate(type = ifelse(type == "", NA, type))
  write_feather(mba, '/Users/fkampf/Documents/pheromone.paper/feather/mba.feather')

} else {
  mba <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/mba.feather')
}
```






### 1.2 Function to load connectivity
```{r}
fetch_connectivity <- function(synapse_threshold = 5) {
  mba <- mcns_body_annotations() %>%
    mutate(type = coalesce(type, flywire_type, manc_type, hemibrain_type)) %>%
    mutate(cachero.type = str_extract(synonyms, "(?<=Cachero 2010:)[^;]+") %>%
      str_trim())
  connectivity <- cf_partners(cf_ids(malecns = mba %>% pull(bodyid)),
    partners = "o",
    threshold = synapse_threshold
  )
  connectivity <- connectivity %>%
    left_join(
      mba %>%
        select("type", "bodyid", "fru_dsx", "consensus_nt", "flywire_type", "synonyms", "receptor_type", "cachero.type", "dimorphism") %>%
        mutate(bodyid = as.integer(bodyid)) %>%
        rename(pre_type = type, pre_fru_dsx = fru_dsx, pre_nt = consensus_nt, pre_fw_type = flywire_type, pre_synonyms = synonyms, pre_receptor_type = receptor_type, pre.dimorphism = dimorphism, pre.cachero.type = cachero.type),
      by = c("pre_id" = "bodyid")
    ) %>%
    rename(post_type = type) %>%
    left_join(
      mba %>%
        select("bodyid", "fru_dsx", "consensus_nt", "flywire_type", "synonyms", "receptor_type", "cachero.type", "dimorphism") %>%
        mutate(bodyid = as.integer(bodyid)) %>%
        rename(post_fru_dsx = fru_dsx, post_nt = consensus_nt, post_fw_type = flywire_type, post_synonyms = synonyms, post_receptor_type = receptor_type, post.dimorphism = dimorphism, post.cachero.type = cachero.type),
      by = c("post_id" = "bodyid")
    )
  return(connectivity)
}
```




### 1.3 Load connectivity
```{r}
if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/connectivity.feather')) {
  conn <- fetch_connectivity()
  write_feather(conn, '/Users/fkampf/Documents/pheromone.paper/feather/connectivity.feather')

} else {
  conn <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/connectivity.feather')
}

conn_save <- conn

conn <- conn %>%
  mutate(
    pre_type = case_when(
      grepl("putative_ppk23", pre_receptor_type) ~ "m-cell",
      grepl("putative_ppk25", pre_receptor_type) ~ "f-cell",
      TRUE ~ pre_type
    ),
    post_type = case_when(
      grepl("putative_ppk23", post_receptor_type) ~ "m-cell",
      grepl("putative_ppk25", post_receptor_type) ~ "f-cell",
      TRUE ~ post_type
    )
  )
```

## 2 Adjacency matrix

With the enriched connectivity, build a column/row-normalised adjacency matrix that becomes the weighted igraph backbone for all path searches.

### 2.1 Function adjacency matrix
```{r}
calculate_normed_adj_matrix <- function(connectivity, cell.or.type = "type", pre.or.post = "pre") {
  colScale <- function(A, na.rm = TRUE) {
    scalefac <- 1 / Matrix::colSums(A)
    if (na.rm) scalefac[!is.finite(scalefac)] <- 0
    B <- A %*% Matrix::Diagonal(x = scalefac)
    B
  }
  rowScale <- function(A, na.rm = TRUE) {
    scalefac <- 1 / Matrix::rowSums(A)
    if (na.rm) scalefac[!is.finite(scalefac)] <- 0
    B <- Matrix::Diagonal(x = scalefac) %*% A
    B
  }
  if (cell.or.type == "cell") {
    unique.identifier <- union(as.character(connectivity$pre_id), as.character(connectivity$post_id))
    adj.matrix <- sparseMatrix(
      i = match(connectivity$pre_id, unique.identifier),
      j = match(connectivity$post_id, unique.identifier),
      x = connectivity$weight,
      dims = c(length(unique.identifier), length(unique.identifier)),
      dimnames = list(unique.identifier, unique.identifier)
    )
  } else {
    unique.identifier <- union(connectivity$pre_type, connectivity$post_type)
    adj.matrix <- sparseMatrix(
      i = match(connectivity$pre_type, unique.identifier),
      j = match(connectivity$post_type, unique.identifier),
      x = connectivity$weight,
      dims = c(length(unique.identifier), length(unique.identifier)),
      dimnames = list(unique.identifier, unique.identifier)
    )
  }
  if (pre.or.post == "pre") {
    adj.matrix.normed.pre <- rowScale(adj.matrix)
    colnames(adj.matrix.normed.pre) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.pre) <- rownames(adj.matrix)
    return(adj.matrix.normed.pre)
  } else if (pre.or.post == "avg") {
    adj.matrix.normed.post <- colScale(adj.matrix)
    colnames(adj.matrix.normed.post) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.post) <- rownames(adj.matrix)
    adj.matrix.normed.pre <- rowScale(adj.matrix)
    colnames(adj.matrix.normed.pre) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.pre) <- rownames(adj.matrix)

    return(avg_mat <- (adj.matrix.normed.post + adj.matrix.normed.post) / 2)
  } else {
    adj.matrix.normed.post <- colScale(adj.matrix)
    colnames(adj.matrix.normed.post) <- colnames(adj.matrix)
    rownames(adj.matrix.normed.post) <- rownames(adj.matrix)
    return(adj.matrix.normed.post)
  }
}
```

### 2.2 Create adjacency matrix
```{r}
use.clone <- FALSE
conn <- conn_save
conn <- conn %>%
  mutate(pre_type = coalesce(pre_type, pre_fw_type), post_type = coalesce(post_type, post_fw_type)) %>%
  mutate(
    pre_type = if_else(is.na(pre_type), as.character(bodyid), pre_type),
    post_type = if_else(is.na(post_type), as.character(partner), post_type)
  ) %>%
  mutate(pre_type = gsub("[()]", "", pre_type)) %>%
  mutate(post_type = gsub("[()]", "", post_type))


if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/adj.matrix.feather')) {
  adj.matrix <- calculate_normed_adj_matrix(conn, cell.or.type = "type", pre.or.post = "post")
  saveRDS(adj.matrix, '/Users/fkampf/Documents/pheromone.paper/feather/adj.matrix.rds')

} else {
  adj.matrix <- readRDS('/Users/fkampf/Documents/pheromone.paper/feather/adj.matrix.rds')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/graph.general.rds')) {
  graph.general <- graph_from_adjacency_matrix(
    adj.matrix,
    mode = "directed",
    weighted = TRUE,
    diag = FALSE
  )
  saveRDS(graph.general, '/Users/fkampf/Documents/pheromone.paper/feather/graph.general.rds')

} else {
  graph.general <- readRDS('/Users/fkampf/Documents/pheromone.paper/feather/graph.general.rds')
}


```



## 2.2 Define kstrongest path function
```{r}
add_valence_flag <- function(df, nt_by_type, is_inhib_by_nt) {
  df %>%
    rowwise() %>%
    mutate(
      # split path and drop endpoint
      nodes = list(setdiff(strsplit(path, " -> ", fixed = TRUE)[[1]], end)),
      # lookup NTs
      nts = list(unname(nt_by_type[unlist(nodes)])),
      # lookup inhibitory flags
      inhib = list(unname(is_inhib_by_nt[unlist(nts)])),
      # count inhibitors
      n_inhib = sum(unlist(inhib), na.rm = TRUE),
      # convert to +1 / -1
      d = ifelse(n_inhib %% 2 == 0, 1, -1)
    ) %>%
    ungroup()
}


find_k_strongest_paths <- function(
  g,
  starts,
  targets,
  mba,
  n_paths = 3,
  diversity = c("otheredges", "othernodes", "none"),
  ignore_pattern = NULL # grepl() pattern; matched node names are excluded (start/target kept),
) {
  type2nt <- mba %>%
    select(type, consensus_nt) %>%
    group_by(type) %>%
    distinct() %>%
    rename(nt = consensus_nt)
  nt_by_type <- setNames(type2nt$nt, type2nt$type)
  inhibitory_nts <- c("gaba", "glycine", "histamine")
  all_nts <- unique(type2nt$nt)
  is_inhib_by_nt <- setNames(all_nts %in% inhibitory_nts, all_nts)

  diversity <- match.arg(diversity)

  # optional: drop nodes matching ignore_pattern (but never drop starts/targets)
  if (!is.null(ignore_pattern)) {
    drop <- V(g)$name[grepl(ignore_pattern, V(g)$name)]
    keep <- unique(c(starts, targets))
    drop <- setdiff(drop, keep)
    if (length(drop)) g <- igraph::delete_vertices(g, drop)
  }

  # weights → log-costs; guard zeros/NAs
  w <- E(g)$weight
  if (is.null(w)) stop("Edges must have numeric 'weight'.")
  w[!is.finite(w) | w <= 0] <- .Machine$double.eps
  log_w <- -log(w)

  results <- list()
  all_nodes <- character(0)

  for (s in starts) {
    for (t in targets) {
      if (!(s %in% V(g)$name) || !(t %in% V(g)$name)) {
        results[[paste(s, t, sep = "->")]] <- list(list(
          start = s, end = t, path = NA_character_, strength = NA_real_, hops = NA_integer_
        ))
        next
      }

      g_tmp <- g
      E(g_tmp)$log_weight <- log_w
      pair_paths <- list()

      for (i in seq_len(n_paths)) {
        sp <- igraph::shortest_paths(
          g_tmp,
          from = s, to = t,
          weights = E(g_tmp)$log_weight,
          output = "both"
        )
        if (length(sp$vpath[[1]]) == 0) break

        vpath <- sp$vpath[[1]]
        epath <- sp$epath[[1]]

        final_strength <- exp(-sum(E(g_tmp)[epath]$log_weight))
        hops <- length(epath)

        pair_paths[[paste0("path", i)]] <- list(
          start = s,
          end = t,
          path = paste(V(g)[vpath]$name, collapse = " -> "),
          strength = final_strength,
          hops = hops
        )

        all_nodes <- c(all_nodes, V(g)[vpath]$name)

        if (diversity == "othernodes") {
          inter <- setdiff(V(g)[vpath]$name, c(s, t))
          if (length(inter)) g_tmp <- igraph::delete_vertices(g_tmp, inter)
        } else if (diversity == "otheredges") {
          g_tmp <- igraph::delete_edges(g_tmp, epath)
        }
      }

      if (length(pair_paths) == 0) {
        pair_paths <- list(list(
          start = s, end = t, path = NA_character_, strength = NA_real_, hops = NA_integer_
        ))
      }

      results[[paste(s, t, sep = "->")]] <- pair_paths
    }
  }

  # flatten
  results_df <- do.call(rbind, lapply(results, function(pl) {
    do.call(rbind, lapply(pl, function(r) {
      data.frame(
        start = r$start, end = r$end, path = r$path,
        strength = r$strength, hops = r$hops,
        stringsAsFactors = FALSE
      )
    }))
  }))

  results_df_wo_na <- dplyr::filter(results_df, !is.na(strength))
  all_nodes <- unique(all_nodes)

  results_df_wo_na <- add_valence_flag(results_df_wo_na, nt_by_type, is_inhib_by_nt) %>%
    mutate(valence = ifelse(d == 1L, "excitatory", "inhibitory"))

  list(df = results_df_wo_na, nodes = all_nodes, raw = results)
}
```
## 3 Downstream target selection

Derive frequently targeted downstream neuron types for both vAB3 and PPN1 by summarising partner synapse weights. We drop broad projection categories (AN/IN) and keep targets contributing at least 0.1% of outgoing weight so subsequent plots focus on substantial partners.

```{r downstream-target-selection}

all.PPN1.ids <- mba %>%
  filter(grepl("PPN1", synonyms)) %>%
  pull(bodyid)
all.vAB3.ids <- mba %>%
  filter(grepl("vAB3", synonyms)) %>%
  pull(bodyid)

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/target.vAB3.all.feather')) {
  target.vAB3.all <- cf_partner_summary(cf_ids(malecns = all.vAB3.ids), partners = "out", normalise = F) %>%
    group_by(type.post) %>%
    summarize(weight = sum(weight)) %>%
    filter(!grepl("AN", type.post)) %>%
    filter(!grepl("IN", type.post)) %>%
    arrange(desc(weight)) %>%
    filter(weight / sum(weight) >= 0.001) %>%
    filter(!is.na(type.post)) %>%
    pull(type.post)
  saveRDS(target.vAB3.all, '/Users/fkampf/Documents/pheromone.paper/feather/target.vAB3.all.rds')

} else {
  target.vAB3.all <- readRDS('/Users/fkampf/Documents/pheromone.paper/feather/target.vAB3.all.rds')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/target.PPN1.all.feather')) {
  target.PPN1.all <- cf_partner_summary(cf_ids(malecns = all.PPN1.ids), partners = "out", normalise = F) %>%
    group_by(type.post) %>%
    summarize(weight = sum(weight)) %>%
    filter(!grepl("AN", type.post)) %>%
    filter(!grepl("IN", type.post)) %>%
    arrange(desc(weight)) %>%
    filter(weight / sum(weight) >= 0.001) %>%
    filter(!is.na(type.post)) %>%
    pull(type.post)
  saveRDS(target.vAB3.all, '/Users/fkampf/Documents/pheromone.paper/feather/target.PPN1.all.rds')

} else {
  target.PPN1.all <- readRDS('/Users/fkampf/Documents/pheromone.paper/feather/target.PPN1.all.rds')
}


target.vAB3.all <- c(target.vAB3.all[1:10], intersect(target.vAB3.all, target.PPN1.all)[1:3])
target.PPN1.all <- c(target.PPN1.all[1:10], intersect(target.vAB3.all, target.PPN1.all)[1:3])

```

### 3.1 Olfactory strongest paths (DA1 & VA1v)

For male (PPN1) and female (vAB3) downstream partners, evaluate the top three strongest paths originating from DA1 and VA1v ORNs. Compare path strengths, hop counts, and inhibitory/excitatory valence across datasets.

```{r strongest-paths-olfactory}

start.types.DA1 <- c("ORN_DA1")
start.types.VA1v <- c("ORN_VA1v")

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.DA1.2.vAB3.feather')) {
  res.vAB3.DA1 <- find_k_strongest_paths(graph.general, starts = start.types.DA1, targets = target.vAB3.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.vAB3.DA1$df$dataset <- "vAB3"
  strongest.1000.paths.DA1.2.vAB3 <- res.vAB3.DA1$df
  write_feather(strongest.1000.paths.DA1.2.vAB3, "/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.DA1.2.vAB3.feather")

} else {
  strongest.1000.paths.DA1.2.vAB3 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.DA1.2.vAB3.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.DA1.2.PPN1.feather')) {
  res.PPN1.DA1 <- find_k_strongest_paths(graph.general, starts = start.types.DA1, targets = target.PPN1.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.PPN1.DA1$df$dataset <- "PPN1"
  strongest.1000.paths.DA1.2.PPN1 <- res.PPN1.DA1$df
  write_feather(strongest.1000.paths.DA1.2.PPN1,'/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.DA1.2.PPN1.feather')

} else {
  strongest.1000.paths.DA1.2.PPN1 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.DA1.2.PPN1.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.VA1v.2.vAB3.feather')) {
  res.vAB3.VA1v <- find_k_strongest_paths(graph.general, starts = start.types.VA1v, targets = target.vAB3.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.vAB3.VA1v$df$dataset <- "vAB3"
  strongest.1000.paths.VA1v.2.vAB3 <- res.vAB3.VA1v$df
  write_feather(strongest.1000.paths.VA1v.2.vAB3, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.VA1v.2.vAB3.feather')

} else {
  strongest.1000.paths.VA1v.2.vAB3 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.VA1v.2.vAB3.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.VA1v.2.PPN1.feather')) {
  res.PPN1.VA1v <- find_k_strongest_paths(graph.general, starts = start.types.VA1v, targets = target.PPN1.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.PPN1.VA1v$df$dataset <- "PPN1"
  strongest.1000.paths.VA1v.2.PPN1 <- res.PPN1.VA1v$df
  write_feather(strongest.1000.paths.VA1v.2.PPN1, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.VA1v.2.PPN1.feather')

} else {
  strongest.1000.paths.VA1v.2.PPN1 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.VA1v.2.PPN1.feather')
}


df_all.all.DA1 <- bind_rows(strongest.1000.paths.DA1.2.PPN1, strongest.1000.paths.DA1.2.vAB3)
df_all.all.VA1v <- bind_rows(strongest.1000.paths.VA1v.2.vAB3, strongest.1000.paths.VA1v.2.PPN1)


t_res.DA1 <- t.test(log(strength) ~ dataset, data = df_all.all.DA1)
pval.DA1 <- unname(t_res.DA1$p.value)
ann.DA1 <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval.DA1,
  y.position  = max(df_all.all.DA1$strength, na.rm = TRUE) * 1.12
)

t_res.VA1v <- t.test(log(strength) ~ dataset, data = df_all.all.VA1v)
pval.VA1v <- unname(t_res.VA1v$p.value)
ann.VA1v <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval.VA1v,
  y.position  = max(df_all.all.VA1v$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.DA1, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength DA1") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann.DA1,
    label = "p", # use the column 'p'
    tip.length = 0
  ) +
  scale_y_log10()

ggplot(df_all.all.VA1v, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength VA1v") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann.VA1v,
    label = "p", # use the column 'p'
    tip.length = 0
  ) +
  scale_y_log10()


ggplot(df_all.all.DA1, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Hops in strongest path DA1") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(df_all.all.VA1v, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Hops in strongest path VA1v") +
  theme(plot.title = element_text(hjust = 0.5))


ann_strength.DA1 <- df_all.all.DA1 %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(log(strength) ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

ann_strength.VA1v <- df_all.all.VA1v %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(log(strength) ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.DA1, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (DA1) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~valence, nrow = 1) +
  stat_pvalue_manual(ann_strength.DA1, label = "p", tip.length = 0)

ggplot(df_all.all.VA1v, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (VA1v) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~valence, nrow = 1) +
  stat_pvalue_manual(ann_strength.VA1v, label = "p", tip.length = 0)
```

### 3.2 Auditory strongest paths

Aggregate strongest paths for mechanosensory neurons annotated as auditory and compare path strength distributions across datasets and valence assignments.

```{r strongest-paths-auditory}
start.types.aud <- mba %>%
  filter(grepl("cb_sensory", superclass)) %>%
  filter(grepl("auditory", subclass)) %>%
  pull(type) %>%
  unique()

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.auditory.2.vAB3.feather')) {
  res.vAB3.aud <- find_k_strongest_paths(graph.general, starts = start.types.aud, targets = target.vAB3.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.vAB3.aud$df$dataset <- "vAB3"
  strongest.1000.paths.auditory.2.vAB3 <- res.vAB3.aud$df
  write_feather(strongest.1000.paths.auditory.2.vAB3, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.auditory.2.vAB3.feather')

} else {
  strongest.1000.paths.auditory.2.vAB3 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.auditory.2.vAB3.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.auditory.2.PPN1.feather')) {
  res.PPN1.aud <- find_k_strongest_paths(graph.general, starts = start.types.aud, targets = target.PPN1.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.PPN1.aud$df$dataset <- "PPN1"
  strongest.1000.paths.auditory.2.PPN1 <- res.PPN1.aud$df
  write_feather(strongest.1000.paths.auditory.2.PPN1, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.auditory.2.PPN1.feather')

} else {
  strongest.1000.paths.auditory.2.PPN1 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.auditory.2.PPN1.feather')
}

df_all.all.aud <- bind_rows(strongest.1000.paths.auditory.2.PPN1, strongest.1000.paths.auditory.2.vAB3)

t_res <- t.test(log(strength) ~ dataset, data = df_all.all.aud)
pval <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.aud$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.aud, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength auditory") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p", # use the column 'p'
    tip.length = 0
  ) +
  scale_y_log10()


ggplot(df_all.all.aud, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Hops in strongest path auditory") +
  theme(plot.title = element_text(hjust = 0.5))


ann_strength <- df_all.all.aud %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(log(strength) ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.aud, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (auditory) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```

### 3.3 Visual strongest paths

Repeat the strongest-path comparison for visual modalities derived from olfactory superclasses, highlighting differences in path length and balance of inhibitory/excitatory routes.

```{r strongest-paths-visual}
start.types.vis <- mba %>%
  filter(superclass == "ol_sensory") %>%
  pull(type) %>%
  unique()


if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.visual.2.vAB3.feather')) {
  res.vAB3.vis <- find_k_strongest_paths(graph.general, starts = start.types.vis, targets = target.vAB3.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.vAB3.vis$df$dataset <- "vAB3"
  strongest.1000.paths.visual.2.vAB3 <- res.vAB3.vis$df
  write_feather(strongest.1000.paths.visual.2.vAB3, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.visual.2.vAB3.feather')

} else {
  strongest.1000.paths.visual.2.vAB3 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.visual.2.vAB3.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.visual.2.PPN1.feather')) {
  res.PPN1.vis <- find_k_strongest_paths(graph.general, starts = start.types.vis, targets = target.PPN1.all, n_paths = 1000, diversity = "otheredges", mba = mba)
  res.PPN1.vis$df$dataset <- "PPN1"
  strongest.1000.paths.visual.2.PPN1 <- res.PPN1.vis$df
  write_feather(strongest.1000.paths.visual.2.PPN1, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.visual.2.PPN1.feather')

} else {
  strongest.1000.paths.visual.2.PPN1 <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.visual.2.PPN1.feather')
}



df_all.all.vis <- bind_rows(strongest.1000.paths.visual.2.vAB3, strongest.1000.paths.visual.2.PPN1)


t_res <- t.test(log(strength) ~ dataset, data = df_all.all.vis)
pval <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.vis$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.vis, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength Visual") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p", # use the column 'p'
    tip.length = 0
  ) +
  scale_y_log10()


ggplot(df_all.all.vis, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Hops in strongest path Visual") +
  theme(plot.title = element_text(hjust = 0.5))


ann_strength <- df_all.all.vis %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(log(strength) ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.vis, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (visual) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```

### 3.4 PPK23 strongest paths

Explore strongest paths seeded from PPK23 chemosensory neurons, both with explicit exclusion filters and when allowing all targets, to assess modality-specific routing differences.

```{r strongest-paths-ppk23}
# contact chemosensor ppk23

start.types.ppk23 <- mba %>%
  filter(grepl("ppk23", receptor_type)) %>%
  pull(type) %>%
  unique()

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.vAB3.excluded.feather')) {
  res.vAB3.ppk23 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk23,
    targets = target.vAB3.all,
    n_paths = 3,
    diversity = "otheredges",
    ignore_pattern = "AN09B017",
    mba = mba
  )
  res.vAB3.ppk23$df$dataset <- "vAB3"
  strongest.1000.paths.ppk23.2.vAB3.excluded<- res.vAB3.ppk23$df
  write_feather(strongest.1000.paths.ppk23.2.vAB3.excluded, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.vAB3.excluded.feather')

} else {
  strongest.1000.paths.ppk23.2.vAB3.excluded <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.vAB3.excluded.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.PPN1.excluded.feather')) {
  res.PPN1.ppk23 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk23,
    targets = target.PPN1.all,
    n_paths = 3,
    diversity = "otheredges",
    ignore_pattern = "AN05B102",
    mba = mba
  )
  res.PPN1.ppk23$df$dataset <- "PPN1"
  strongest.1000.paths.ppk23.2.PPN1.excluded<- res.PPN1.ppk23$df
  write_feather(strongest.1000.paths.ppk23.2.PPN1.excluded, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.PPN1.excluded.feather')

} else {
  strongest.1000.paths.ppk23.2.PPN1.excluded <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.PPN1.excluded.feather')
}
#included
if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.vAB3.included.feather')) {
  res.vAB3.ppk23 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk23,
    targets = target.vAB3.all,
    n_paths = 3,
    diversity = "otheredges",
    mba = mba
  )
  res.vAB3.ppk23$df$dataset <- "vAB3"
  strongest.1000.paths.ppk23.2.vAB3.included<- res.vAB3.ppk23$df
  write_feather(strongest.1000.paths.ppk23.2.vAB3.included, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.vAB3.included.feather')

} else {
  strongest.1000.paths.ppk23.2.vAB3.included <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.vAB3.included.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.PPN1.included.feather')) {
  res.PPN1.ppk23 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk23,
    targets = target.PPN1.all,
    n_paths = 3,
    diversity = "otheredges",
    mba = mba
  )
  res.PPN1.ppk23$df$dataset <- "PPN1"
  strongest.1000.paths.ppk23.2.PPN1.included<- res.PPN1.ppk23$df
  write_feather(strongest.1000.paths.ppk23.2.PPN1.eincludedcluded, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.PPN1.excludincludeded.feather')

} else {
  strongest.1000.paths.ppk23.2.PPN1.included <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk23.2.PPN1.included.feather')
}


  
df_all.all.ppk23.excluded <- bind_rows(strongest.1000.paths.ppk23.2.PPN1.excluded, strongest.1000.paths.ppk23.2.vAB3.excluded)
df_all.all.ppk23.included <- bind_rows(strongest.1000.paths.ppk23.2.PPN1.included, strongest.1000.paths.ppk23.2.vAB3.included)

t_res <- t.test(log(strength) ~ dataset, data = df_all.all.ppk23.included)
pval <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.ppk23.included$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.ppk23.included, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength PPK23") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p", # use the column 'p'
    tip.length = 0
  ) +
  scale_y_log10()


ggplot(df_all.all.ppk23.included, aes(x = dataset, y = hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Hops in strongest path PPK23") +
  theme(plot.title = element_text(hjust = 0.5))


ann_strength <- df_all.all.ppk23.included %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(log(strength) ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.ppk23.included, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (PPK23) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```
### 3.5 PPK25 strongest paths

Repeat the analysis for PPK25 chemosensors to highlight sex-specific routing differences when these neurons are included or excluded from the strongest-path search.

```{r strongest-paths-ppk25}
# contact chemosensor ppk25
start.types.ppk25 <- mba %>%
  filter(grepl("ppk25", receptor_type)) %>%
  pull(type) %>%
  unique()

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.vAB3.excluded.feather')) {
  res.vAB3.ppk25 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk25,
    targets = target.vAB3.all,
    n_paths = 3,
    diversity = "otheredges",
    ignore_pattern = "AN09B017",
    mba = mba
  )
  res.vAB3.ppk25$df$dataset <- "vAB3"
  strongest.1000.paths.ppk25.2.vAB3.excluded<- res.vAB3.ppk25$df
  write_feather(strongest.1000.paths.ppk25.2.vAB3.excluded, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.vAB3.excluded.feather')

} else {
  strongest.1000.paths.ppk25.2.vAB3.excluded <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.vAB3.excluded.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.PPN1.excluded.feather')) {
  res.PPN1.ppk25 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk25,
    targets = target.PPN1.all,
    n_paths = 3,
    diversity = "otheredges",
    ignore_pattern = "AN05B102",
    mba = mba
  )
  res.PPN1.ppk25$df$dataset <- "PPN1"
  strongest.1000.paths.ppk25.2.PPN1.excluded<- res.PPN1.ppk25$df
  write_feather(strongest.1000.paths.ppk25.2.PPN1.excluded, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.PPN1.excluded.feather')

} else {
  strongest.1000.paths.ppk25.2.PPN1.excluded <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.PPN1.excluded.feather')
}
#included
if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.vAB3.included.feather')) {
  res.vAB3.ppk25 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk25,
    targets = target.vAB3.all,
    n_paths = 3,
    diversity = "otheredges",
    mba = mba
  )
  res.vAB3.ppk25$df$dataset <- "vAB3"
  strongest.1000.paths.ppk25.2.vAB3.included<- res.vAB3.ppk25$df
  write_feather(strongest.1000.paths.ppk25.2.vAB3.included, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.vAB3.included.feather')

} else {
  strongest.1000.paths.ppk25.2.vAB3.included <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.vAB3.included.feather')
}

if (load_or_execute('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.PPN1.included.feather')) {
  res.PPN1.ppk25 <- find_k_strongest_paths(graph.general,
    starts = start.types.ppk25,
    targets = target.PPN1.all,
    n_paths = 3,
    diversity = "otheredges",
    mba = mba
  )
  res.PPN1.ppk25$df$dataset <- "PPN1"
  strongest.1000.paths.ppk25.2.PPN1.included<- res.PPN1.ppk25$df
  write_feather(strongest.1000.paths.ppk25.2.PPN1.eincludedcluded, '/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.PPN1.excludincludeded.feather')

} else {
  strongest.1000.paths.ppk25.2.PPN1.included <- read_feather('/Users/fkampf/Documents/pheromone.paper/feather/strongest.paths/strongest.1000.paths.ppk25.2.PPN1.included.feather')
}


  
df_all.all.ppk25.excluded <- bind_rows(strongest.1000.paths.ppk25.2.PPN1.excluded, strongest.1000.paths.ppk25.2.vAB3.excluded)
df_all.all.ppk25.included <- bind_rows(strongest.1000.paths.ppk25.2.PPN1.included, strongest.1000.paths.ppk25.2.vAB3.included)


t_res <- t.test(log(strength) ~ dataset, data = df_all.all.ppk25.included)
pval <- unname(t_res$p.value)
ann <- data.frame(
  group1      = "PPN1",
  group2      = "vAB3",
  p           = pval,
  y.position  = max(df_all.all.ppk25.included$strength, na.rm = TRUE) * 1.12
)

ggplot(df_all.all.ppk25.included, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  theme_bw() +
  labs(title = "Path strength ppk25") +
  theme(plot.title = element_text(hjust = 0.5)) +
  stat_pvalue_manual(
    ann,
    label = "p", # use the column 'p'
    tip.length = 0
  ) +§
  scale_y_log10()


ggplot(df_all.all.ppk25.included, aes(x = dataset, y =   hops)) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.6) +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Hops in strongest path ppk25") +
  theme(plot.title = element_text(hjust = 0.5))


ann_strength <- df_all.all.ppk25.included %>%
  group_by(valence) %>%
  summarise(
    group1 = "PPN1",
    group2 = "vAB3",
    p = unname(t.test(log(strength) ~ dataset)$p.value),
    y.position = max(strength, na.rm = TRUE) * 1.12,
    .groups = "drop"
  )

# strength boxplots, split by valence
ggplot(df_all.all.ppk25.included, aes(x = dataset, y = strength)) +
  geom_boxplot(outlier.shape = NA, fill = "lightgray") +
  geom_jitter(width = 0.2, height = 0, alpha = 0.4, color = "blue") +
  scale_y_log10() +
  theme_bw() +
  labs(title = "Path strength (ppk25) by valence") +
  theme(plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~valence, nrow = 1) +
  stat_pvalue_manual(ann_strength, label = "p", tip.length = 0)
```
## 4 Modality composition analyses

Summarise modality contributions to downstream targets using pie charts and connected scatterplots. The helper functions below reshape the strongest-path data into modality-level proportions.

### 4.1 External inputs (excluding PPN1/vAB3)

Focus on modalities other than the target circuit itself by excluding PPN1 and vAB3 when computing modality contributions.

```{r modality-composition-external}

# add modality labels (as you already do)
df_all.all.ppk25.excluded$modality <- "female.touch"
df_all.all.ppk23.excluded$modality <- "male.touch"
df_all.all.aud$modality <- "auditory"
df_all.all.DA1$modality <- "DA1"
df_all.all.VA1v$modality <- "VA1v"
df_all.all.vis$modality <- "visual"

all.modalities.excluded <- rbind(
  df_all.all.ppk25,
  df_all.all.ppk23.excluded,
  df_all.all.VA1v,
  df_all.all.DA1
)

pie_data <- function(df, dataset_name, valence_keep = NULL) {
  df %>%
    filter(dataset == dataset_name) %>%
    {
      if (!is.null(valence_keep)) filter(., valence %in% valence_keep) else .
    } %>%
    group_by(end, modality) %>%
    summarise(total_strength = sum(strength, na.rm = TRUE), .groups = "drop_last") %>%
    mutate(prop = total_strength / sum(total_strength)) %>%
    ungroup() %>%
    filter(is.finite(prop)) # drop ends with all-zero strength
}

pie_plot <- function(pdat, title_txt) {
  ggplot(pdat, aes(x = "", y = prop, fill = modality)) +
    geom_col(width = 1, color = "white") +
    coord_polar(theta = "y") +
    facet_wrap(~end) +
    theme_void() +
    labs(title = title_txt) +
    geom_text(aes(label = percent(prop, accuracy = 1)),
      position = position_stack(vjust = 0.5), size = 2
    )
}

# PPN1
ppn1_all <- pie_data(all.modalities.excluded, "PPN1", NULL)
ppn1_exc <- pie_data(all.modalities.excluded, "PPN1", c("excitatory", 1)) # handles either text or numeric
ppn1_inh <- pie_data(all.modalities.excluded, "PPN1", c("inhibitory", -1))

p_ppn1_all <- pie_plot(ppn1_all, "PPN1: modality contribution per target neuron (all)")
p_ppn1_exc <- pie_plot(ppn1_exc, "PPN1: modality contribution per target neuron (excitatory only)")
p_ppn1_inh <- pie_plot(ppn1_inh, "PPN1: modality contribution per target neuron (inhibitory only)")

p_ppn1_all
p_ppn1_exc
p_ppn1_inh

ppn1_all$connection.type <- "all"
ppn1_exc$connection.type <- "excitatory"
ppn1_inh$connection.type <- "inhibitory"

connected.scatterplot.all.ppn1 <- rbind(ppn1_all, ppn1_exc, ppn1_inh) %>%
  mutate(
    x_pos = as.numeric(factor(end, levels = unique(end))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all" ~ 0,
      connection.type == "excitatory" ~ 0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(connected.scatterplot.all.ppn1, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) + # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.ppn1$x_pos),
    labels = unique(connected.scatterplot.all.ppn1$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (excluding PPN1) to post PPN1 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(axis.text.x = element_text(
    angle = 90, hjust = 1,
    color = ifelse(unique(connected.scatterplot.all.ppn1$end) %in% intersect(target.vAB3.all, target.PPN1.all), "red", "black")
  ))

# vAB3
vab3_all <- pie_data(all.modalities.excluded, "vAB3", NULL)
vab3_exc <- pie_data(all.modalities.excluded, "vAB3", c("excitatory", 1))
vab3_inh <- pie_data(all.modalities.excluded, "vAB3", c("inhibitory", -1))

p_vab3_all <- pie_plot(vab3_all, "vAB3: modality contribution per target neuron (all)")
p_vab3_exc <- pie_plot(vab3_exc, "vAB3: modality contribution per target neuron (excitatory only)")
p_vab3_inh <- pie_plot(vab3_inh, "vAB3: modality contribution per target neuron (inhibitory only)")


p_vab3_all
p_vab3_exc
p_vab3_inh

# connected scatter plot

vab3_all$connection.type <- "all"
vab3_exc$connection.type <- "excitatory"
vab3_inh$connection.type <- "inhibitory"

connected.scatterplot.all.vab3 <- rbind(vab3_all, vab3_exc, vab3_inh) %>%
  mutate(
    x_pos = as.numeric(factor(end, levels = unique(end))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all" ~ 0,
      connection.type == "excitatory" ~ 0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(connected.scatterplot.all.vab3, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) + # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.vab3$x_pos),
    labels = unique(connected.scatterplot.all.vab3$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (excluding vAB3) to post vAB3 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(axis.text.x = element_text(
    angle = 90, hjust = 1,
    color = ifelse(unique(connected.scatterplot.all.vab3$end) %in% intersect(target.vAB3.all, target.PPN1.all), "red", "black")
  ))
```

### 4.2 Including circuit feedback

Repeat the modality composition analysis while keeping PPN1/vAB3 contributions to highlight feedback within the circuit.

```{r modality-composition-including}
# add modality labels (as you already do)
df_all.all.ppk25.included$modality <- "female.touch"
df_all.all.ppk23.included$modality <- "male.touch"
df_all.all.aud$modality <- "auditory"
df_all.all.DA1$modality <- "DA1"
df_all.all.VA1v$modality <- "VA1v"
df_all.all.vis$modality <- "visual"

# emphasise touch modalities when including PPN1/vAB3 contributions
all.modalities.included <- dplyr::bind_rows(
   df_all.all.ppk25.included %>% mutate(across(where(is.character), list)),
   df_all.all.ppk23.included %>% mutate(across(where(is.character), list))
 )


# PPN1
ppn1_all <- pie_data(all.modalities.included, "PPN1", NULL)
ppn1_exc <- pie_data(all.modalities.included, "PPN1", c("excitatory", 1)) # handles either text or numeric
ppn1_inh <- pie_data(all.modalities.included, "PPN1", c("inhibitory", -1))

p_ppn1_all <- pie_plot(ppn1_all, "PPN1: modality contribution per target neuron (all)")
p_ppn1_exc <- pie_plot(ppn1_exc, "PPN1: modality contribution per target neuron (excitatory only) Including PPN1")
p_ppn1_inh <- pie_plot(ppn1_inh, "PPN1: modality contribution per target neuron (inhibitory only) Including PPN1")

p_ppn1_all
p_ppn1_exc
p_ppn1_inh

ppn1_all$connection.type <- "all"
ppn1_exc$connection.type <- "excitatory"
ppn1_inh$connection.type <- "inhibitory"

connected.scatterplot.all.include.ppn1 <- rbind(ppn1_all, ppn1_exc, ppn1_inh) %>%
  mutate(
    x_pos = as.numeric(factor(end, levels = unique(end))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all" ~ 0,
      connection.type == "excitatory" ~ 0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(connected.scatterplot.all.include.ppn1, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) + # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.include.ppn1$x_pos),
    labels = unique(connected.scatterplot.all.include.ppn1$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including PPN1) to post PPN1 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(axis.text.x = element_text(
    angle = 90, hjust = 1,
    color = ifelse(unique(connected.scatterplot.all.ppn1$end) %in% intersect(target.vAB3.all, target.PPN1.all), "red", "black")
  ))

temp_df <- connected.scatterplot.all.include.ppn1 %>%
  group_by(connection.type, modality) %>%
  summarize(strength = sum(total_strength)) %>%
  group_by(connection.type) %>%
  mutate(prop = strength / sum(strength)) %>%
  ungroup() %>%
  mutate(
    x_pos = as.numeric(factor(modality, levels = unique(modality))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all" ~ 0,
      connection.type == "excitatory" ~ 0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(temp_df, aes(x = x_jittered, y = prop, group = modality, color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(temp_df$x_pos),
    labels = unique(temp_df$modality)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including PPN1) to post PPN1 (all) by connection type across neurons",
    x = "Modality",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

ggplot(temp_df %>% filter(connection.type != "all"), aes(x = connection.type, y = prop, fill = modality)) +
  geom_bar(stat = "identity", position = "stack", color = "black", linewidth = 0.2) +
  theme_bw() +
  labs(
    title = "Neurotransmitter valence of input (including PPN1) to post PPN1 (all) by connection type",
    x = "Modality",
    y = "Proportion",
    fill = "Connection type"
  ) +
  theme(axis.text.x = element_text(hjust = 0.5)) +
  theme(
    plot.title = element_text(hjust = 0.5)
  )


# vAB3
vab3_all <- pie_data(all.modalities.included, "vAB3", NULL)
vab3_exc <- pie_data(all.modalities.included, "vAB3", c("excitatory", 1))
vab3_inh <- pie_data(all.modalities.included, "vAB3", c("inhibitory", -1))

p_vab3_all <- pie_plot(vab3_all, "vAB3: modality contribution per target neuron (all)")
p_vab3_exc <- pie_plot(vab3_exc, "vAB3: modality contribution per target neuron (excitatory only) Including vAB3")
p_vab3_inh <- pie_plot(vab3_inh, "vAB3: modality contribution per target neuron (inhibitory only) Including vAB3")

# print any of these:
p_vab3_all
p_vab3_exc
p_vab3_inh

# connected scatter plot

vab3_all$connection.type <- "all"
vab3_exc$connection.type <- "excitatory"
vab3_inh$connection.type <- "inhibitory"

connected.scatterplot.all.include.vab3 <- rbind(vab3_all, vab3_exc, vab3_inh) %>%
  mutate(
    x_pos = as.numeric(factor(end, levels = unique(end))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all" ~ 0,
      connection.type == "excitatory" ~ 0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(connected.scatterplot.all.include.vab3, aes(x = x_jittered, y = prop, group = interaction(end, modality), color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) + # line inherits modality color
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(connected.scatterplot.all.include.vab3$x_pos),
    labels = unique(connected.scatterplot.all.include.vab3$end)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including vAB3) to post vAB3 (all) by connection type",
    x = "Target neurons",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(axis.text.x = element_text(
    angle = 90, hjust = 1,
    color = ifelse(unique(connected.scatterplot.all.vab3$end) %in% intersect(target.vAB3.all, target.PPN1.all), "red", "black")
  ))


temp_df <- connected.scatterplot.all.include.vab3 %>%
  group_by(connection.type, modality) %>%
  summarize(strength = sum(total_strength)) %>%
  group_by(connection.type) %>%
  mutate(prop = strength / sum(strength)) %>%
  ungroup() %>%
  mutate(
    x_pos = as.numeric(factor(modality, levels = unique(modality))),
    x_shift = case_when(
      connection.type == "inhibitory" ~ -0.2,
      connection.type == "all" ~ 0,
      connection.type == "excitatory" ~ 0.2
    ),
    x_jittered = x_pos + x_shift
  )

ggplot(temp_df, aes(x = x_jittered, y = prop, group = modality, color = modality)) +
  geom_line(alpha = 0.6, linewidth = 0.8) +
  geom_point(aes(shape = connection.type), size = 3, alpha = 0.9) +
  scale_x_continuous(
    breaks = unique(temp_df$x_pos),
    labels = unique(temp_df$modality)
  ) +
  theme_bw() +
  labs(
    title = "Fraction of input (including vAB3) to post vAB3 (all) by connection type across neurons",
    x = "Modality",
    y = "Proportion",
    color = "Modality",
    shape = "Connection type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(temp_df %>% filter(connection.type != "all"), aes(x = connection.type, y = prop, fill = modality)) +
  geom_bar(stat = "identity", position = "stack", color = "black", linewidth = 0.2) +
  theme_bw() +
  labs(
    title = "Neurotransmitter valence of input (including vAB3) to post vAB3 (all) by connection type",
    x = "Modality",
    y = "Proportion",
    fill = "Connection type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5)
  )
```
### 4.3 Stacked barplot of synaptic contributions

Estimate how much of the synaptic budget each modality consumes at the penultimate step along the strongest paths.

```{r strongest-paths-budget}
all.modalities.second_last <- all.modalities.included %>%
  mutate(second_last = map_chr(str_split(path, " -> "), ~ .x[length(.x) - 1]))

pairs <- all.modalities.second_last %>%
  select(second_last, end) %>%
  distinct() %>%
  mutate(weight = igraph::E(graph.general)$weight[
    igraph::get.edge.ids(graph.general, as.vector(t(as.matrix(cur_data()))), directed = TRUE, error = FALSE)
  ])

all.modalities.second_last <- all.modalities.second_last %>%
  left_join(pairs, by = c("second_last", "end"))

aaa <- all.modalities.second_last %>%
  select(second_last, end, weight, modality, dataset) %>%
  distinct() %>%
  group_by(end, modality, dataset) %>%
  summarise(weight = sum(weight) / 5, .groups = "drop")
```

### 4.4 Faceted sanity check

Confirm the aggregated weights visually by faceting barplots across datasets.

```{r strongest-paths-budget-check}
ggplot(aaa, aes(x = end, y = weight, fill = modality)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~dataset, scales = "free_x") +
  theme_minimal() +
  labs(x = "Neuron (end)", y = "Weight", fill = "Modality") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## 5 Cytoscape export

Extract an induced subgraph of interest and push it into Cytoscape for interactive exploration.

### 5.1 Vertex-induced subgraph

```{r cytoscape-export}

input <- all.modalities %>% filter(modality %in% c("male.touch", "female.touch", "DA1", "VA1v"))
# 1) collect unique node names from the path strings
nodes <- unique(unlist(strsplit(input$path, " *-> *")))

# 2) keep only nodes present in the graph
nodes_in_g <- intersect(nodes, V(graph.general)$name)

# 3) induced subgraph on those vertices
g_sub_vertices <- induced_subgraph(graph.general, vids = V(graph.general)[name %in% nodes_in_g])
cytoscapePing() # sanity check
net.suid <- createNetworkFromIgraph(g_sub_vertices, # or g_sub_vertices
  title = "mcns subnetwork",
  collection = "mcns"
)

layoutNetwork("force-directed")
fitContent()
```



### 5.2 Edge-derived subgraph

Parse the strongest paths into edge lists to build a subgraph that respects actual edge usage, then ship the result to Cytoscape with modality metadata.

```{r cytoscape-edge-export}
# Edge-extracted subgraph: parse paths -> build edge list -> select matching edges -> subgraph

input <- all.modalities %>% filter(modality %in% c("male.touch", "female.touch", "DA1", "VA1v"))


paths <- input$path %>%
  as.character() %>%
  na.omit()
parts <- strsplit(paths, " *-+> *")

edge_pairs <- map_dfr(parts, function(x) {
  x <- trimws(x)
  if (length(x) < 2) {
    return(NULL)
  }
  data.frame(from = head(x, -1), to = tail(x, -1), stringsAsFactors = FALSE)
}) %>%
  unique()

eid <- igraph::get.edge.ids(graph.general,
  as.vector(t(as.matrix(edge_pairs))),
  directed = TRUE, error = FALSE
)
eid <- unique(eid[eid > 0])

g_sub_edges <- subgraph.edges(graph.general, eids = eid, delete.vertices = TRUE)


# use `input` (already filtered) — switch to `all.modalities` if you want all
paths <- input$path %>%
  as.character() %>%
  na.omit()
mods <- input$modality[match(paths, input$path)] # align modalities to paths
parts <- strsplit(paths, " *-+> *")

nodes_by_mod <- map2_dfr(parts, mods, function(nodes, m) {
  data.frame(node = trimws(nodes), modality = m, stringsAsFactors = FALSE)
}) %>%
  filter(nzchar(node)) %>%
  distinct(node, modality)

modalities_by_node <- nodes_by_mod %>%
  group_by(node) %>%
  summarise(
    modalities = paste(sort(unique(modality)), collapse = ", "),
    n_modalities = n_distinct(modality),
    .groups = "drop"
  )


# attach to your subgraph vertices
mt <- match(V(g_sub_edges)$name, modalities_by_node$node)
V(g_sub_edges)$modalities <- modalities_by_node$modalities[mt]
V(g_sub_edges)$n_modalities <- modalities_by_node$n_modalities[mt]

V(g_sub_edges)$is_start <- V(g_sub_edges)$name %in% unique(input$start)
V(g_sub_edges)$is_end <- V(g_sub_edges)$name %in% unique(input$end)

V(g_sub_edges)$consensus_nt <- {
  kb <- dplyr::bind_rows(
    dplyr::transmute(mba, name = as.character(bodyid), consensus_nt),
    dplyr::transmute(mba, name = as.character(type), consensus_nt),
    dplyr::transmute(mba, name = as.character(instance), consensus_nt)
  ) |>
    dplyr::filter(!is.na(name) & nzchar(name)) |>
    dplyr::group_by(name) |>
    dplyr::summarise(consensus_nt = dplyr::coalesce(consensus_nt[!is.na(consensus_nt)][1], NA_character_), .groups = "drop")
  kb$consensus_nt[match(V(g_sub_edges)$name, kb$name)]
}


# 5) send to Cytoscape (all vertex/edge attributes preserved)
cytoscapePing()
net.suid <- createNetworkFromIgraph(g_sub_edges,
  title = "mcns subnetwork (edge-extracted)",
  collection = "mcns"
)
layoutNetwork("force-directed")
fitContent()
```
## 6 Identify intermediate mediators

Screen for frequently traversed intermediate neurons (excluding start/targets) and rank them by their prevalence within excitatory strongest paths.

```{r mediator-search}
all.modalities %>%
  filter(
    modality == "male.touch",
    dataset == "PPN1",
    valence == "excitatory"
  ) %>%
  unnest_longer(nodes) %>%
  filter(!nodes %in% c(
    start.types.ppk25,
    start.types.ppk23,
    target.vAB3.all,
    target.PPN1.all
  )) %>%
  count(nodes, sort = TRUE) %>%
  mutate(n_frac = n / max(n)) -> a

mba %>%
  select(type, superclass, bodyid) %>%
  filter(type %in% nodes & !grepl("sensory", superclass)) %>%
  left_join(a, by = c("type" = "nodes")) %>%
  filter(!is.na(n_frac)) -> aaa

aaa <- aaa %>%
  arrange(desc(n_frac)) %>%
  filter(n_frac >= 0.3)
```


### 6.1 Example CN receiving input from MBON and LHN

Render candidate mediator neurons in 3D to contextualise their position relative to MBON and LHN inputs.

```{r mediator-visualisation}
# Example of CN receiving input from MBON and LHN

dir <- "/Users/fkampf/Documents/pheromone.paper/strongest.path/morphology compared across modality valence path"
random_pastel <- function() {
  rgb(runif(1, 0.5, 1), runif(1, 0.5, 1), runif(1, 0.5, 1))
}


anterior <- structure(
  c(
    1, 0, 0, 0,
    0, -1, 0.000000000000000122464679914735, 0,
    0, -0.000000000000000122464679914735, -1, 0,
    0, 0, 0, 1
  ),
  dim = c(4L, 4L)
)

top <- structure(
  c(
    1, 0, 0, 0,
    0, 0, 1, 0,
    0, -1, 0, 0,
    0, 0, 0, 1
  ),
  dim = c(4L, 4L)
)

view <- top

# Switch to cns just for plotting (V9 snapshot doesn't work)
choose_mcns_dataset("cns")
mc_ids <- c(aaa$bodyid)
mcns.meshes <- read_mcns_meshes(mc_ids)
names(mcns.meshes) <- aaa$type
key <- match(names(mcns.meshes), aaa$type)
alphas <- aaa$n_frac[key]
names(alphas) <- names(mcns.meshes)


p1 <- gganat +
  geom_neuron(malecns.surf, rotation_matrix = view, cols = c("grey95", "grey85"), alpha = 0.3) +
  geom_neuron(malecnsvnc.surf, rotation_matrix = view, cols = c("grey95", "grey85"), alpha = 0.3)

p2 <- gganat +
  geom_neuron(malecns.surf, rotation_matrix = anterior, cols = c("grey95", "grey85"), alpha = 0.3) +
  geom_neuron(malecnsvnc.surf, rotation_matrix = anterior, cols = c("grey95", "grey85"), alpha = 0.3)

for (i in seq_along(mcns.meshes)) {
  p1 <- p1 + geom_neuron(mcns.meshes[[i]],
    rotation_matrix = view,
    cols = c(random_pastel()),
    alpha = unname(alphas[i])
  )

  p2 <- p2 + geom_neuron(mcns.meshes[[i]],
    rotation_matrix = anterior,
    cols = c(random_pastel()),
    alpha = unname(alphas[i])
  )
}


path <- "PPN1"
valence <- "excitatory"
modality <- "male.touch"


ggsave(
  file.path(
    dir, "dorsal",
    paste0(path, "_", valence, "_", modality, "_most common neuron in path.png")
  ),
  p1,
  width = 7, height = 7, dpi = 600, bg = "white"
)

ggsave(
  file.path(
    dir, "anterior",
    paste0(path, "_", valence, "_", modality, "_most common neuron in path.png")
  ),
  p2,
  width = 7, height = 7, dpi = 600, bg = "white"
)
## 7 Synapse-level inspection


```
Quantify synapse distributions for frequently traversed mediator candidates, generating scatter, heatmap, and density summaries for each modality/path pairing.
```{r synapse-inspection}
for (modality in c("female.touch", "male.touch")) {
  for (path in c("PPN1", "vAB3")) {
    for (valence in c("excitatory", "inhibitory")) {
      comp1 <- modality
      comp2 <- path
      comp3 <- valence
      all.modalities %>%
        filter(modality == comp1) %>%
        filter(dataset == comp2) %>%
        filter(valence == comp3) %>%
        unnest_longer(nodes) %>%
        filter(!nodes %in% c(
          start.types.ppk25,
          start.types.ppk23,
          target.vAB3.all,
          target.PPN1.all
        )) %>%
        count(nodes, sort = TRUE) %>%
        mutate(n_frac = n / max(n)) -> a

      mba %>%
        select(type, superclass, bodyid) %>%
        filter(type %in% nodes & !grepl("sensory", superclass)) %>%
        left_join(a, by = c("type" = "nodes")) %>%
        filter(!is.na(n_frac)) -> aaa

      aaa <- aaa %>%
        arrange(desc(n_frac)) %>%
        filter(n_frac >= 0.3)


      syn_list <- lapply(aaa$bodyid, function(x) {
        neuprint_get_synapses(x) %>%
          mutate(prepost = as.factor(ifelse(prepost == 1, "input", "output")))
      })


      # assumes: syn_list (list of synapse dfs), aaa$bodyid (vector of bodyids), mba (optional)


      ids <- aaa$bodyid
      stopifnot(length(syn_list) == length(ids))

      # bind all synapses with bodyid (+ optional type)
      syn_all <- bind_rows(
        lapply(seq_along(syn_list), function(i) mutate(syn_list[[i]], bodyid = ids[i]))
      )
      if (exists("mba")) {
        syn_all <- syn_all %>% left_join(select(mba, bodyid, type), by = "bodyid")
      }

      syn_all <- syn_all %>%
        mutate(
          prepost = factor(prepost, levels = c("input", "output"))
        ) %>%
        left_join(aaa %>% distinct(type, .keep_all = TRUE) %>% select(type, n_frac), by = "type")

      base_theme <- theme_minimal() +
        theme(axis.text.x = element_blank(), axis.text.y = element_blank())


      # scatter plot
      p_xy <- ggplot(syn_all, aes(x = x, y = z, color = prepost, alpha = n_frac)) +
        geom_point(size = 0.1) +
        scale_color_manual(values = c(input = "blue", output = "red")) +
        scale_alpha_continuous(range = c(0.0001, 0.01)) +
        scale_y_reverse() +
        coord_fixed() +
        labs(title = "All synapses (XY)") +
        base_theme +
        guides(
          colour = guide_legend(override.aes = list(alpha = 1, size = 2)),
          alpha  = guide_legend(title = "n_frac")
        )

      p_xz <- ggplot(syn_all, aes(x = x, y = y, color = prepost, alpha = n_frac)) +
        geom_point(size = 0.1) +
        scale_color_manual(values = c(input = "blue", output = "red")) +
        scale_alpha_continuous(range = c(0.0001, 0.01)) +
        scale_y_reverse() +
        coord_fixed() +
        labs(title = "All synapses (XZ)") +
        base_theme +
        guides(
          colour = guide_legend(override.aes = list(alpha = 1, size = 2)),
          alpha  = guide_legend(title = "n_frac")
        )

      combined <- p_xy / p_xz + plot_layout(nrow = 2, heights = c(1, 1))
      g <- grid.grabExpr(print(combined))


      ggsave(
        file.path(
          getwd(), "output.synapses.exploration", "scatter",
          paste0(path, "_", valence, "_", modality, "_most common neuron in path synapses.png")
        ),
        g,
        width = 7, height = 7, dpi = 900, bg = "white"
      )


      # heatmap


      # compute common limits
      common_limits <- range(
        ggplot_build(
          ggplot(syn_all, aes(x = x, y = y)) +
            stat_bin2d(bins = 100)
        )$data[[1]]$count,
        na.rm = TRUE
      )

      # define base heatmap function
      heat_map_xz <- function(df, title, show_legend = TRUE) {
        ggplot(df, aes(x = x, y = y)) +
          stat_bin2d(bins = 100, drop = TRUE) +
          scale_fill_viridis_c(
            name = "count",
            trans = "log10",
            limits = common_limits
          ) +
          coord_fixed() +
          scale_y_reverse() +
          labs(title = title, x = "x", y = "z") +
          theme_bw() +
          theme(
            legend.position = if (show_legend) "right" else "none",
            axis.text = element_blank(),
            axis.ticks = element_blank()
          )
      }

      heat_map_xy <- function(df, title, show_legend = TRUE) {
        ggplot(df, aes(x = x, y = z)) +
          stat_bin2d(bins = 150, drop = TRUE) +
          scale_fill_viridis_c(
            name = "count",
            trans = "log10",
            limits = common_limits
          ) +
          coord_fixed() +
          scale_y_reverse() +
          labs(title = title, x = "x", y = "y") +
          theme_bw() +
          theme(
            legend.position = if (show_legend) "right" else "none",
            axis.text = element_blank(),
            axis.ticks = element_blank()
          )
      }

      p_in <- heat_map_xz(filter(syn_all, prepost == "input"), "Input", FALSE)
      p_out <- heat_map_xz(filter(syn_all, prepost == "output"), "Output", FALSE)
      p_all <- heat_map_xz(syn_all, "All synapses", TRUE)
      p_in_xy <- heat_map_xy(filter(syn_all, prepost == "input"), "Input", FALSE)
      p_out_xy <- heat_map_xy(filter(syn_all, prepost == "output"), "Output", FALSE)
      p_all_xy <- heat_map_xy(syn_all, "All synapses", TRUE)



      # one legend only
      legend <- get_legend(p_all + theme(legend.position = "right"))
      p_in <- p_in + theme(legend.position = "none")
      p_out <- p_out + theme(legend.position = "none")
      p_all <- p_all + theme(legend.position = "none")
      p_in_xy <- p_in_xy + theme(legend.position = "none")
      p_out_xy <- p_out_xy + theme(legend.position = "none")
      p_all_xy <- p_all_xy + theme(legend.position = "none")

      r1 <- plot_grid(p_in, p_out, p_all, nrow = 1, rel_widths = c(1, 1, 1), align = "h", axis = "tb")
      r2 <- plot_grid(p_in_xy, p_out_xy, p_all_xy, nrow = 1, rel_widths = c(1.2, 1.2, 1.2), align = "h", axis = "tb")
      grid <- plot_grid(r1, r2, ncol = 1, rel_heights = c(1, 1))

      ggg <- plot_grid(grid, legend, ncol = 2, rel_widths = c(1, 0.12))

      ggsave(
        file.path(
          getwd(), "output.synapses.exploration", "heatmap",
          paste0(path, "_", valence, "_", modality, "_most common neuron in path synapses.png")
        ),
        ggg,
        width = 7, height = 7, dpi = 900, bg = "white"
      )

      # Density

      density_xz <- ggplot(syn_all, aes(x = x, y = y)) +
        stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", bins = 12, alpha = 0.6) +
        facet_wrap(~prepost, ncol = 2) +
        scale_fill_viridis_c(name = "density level") +
        coord_fixed() +
        scale_y_reverse() +
        labs(title = "Density (XZ)", x = "x", y = "z") +
        theme_bw() +
        theme(
          axis.text = element_blank(),
          axis.ticks = element_blank()
        )

      density_xy <- ggplot(syn_all, aes(x = x, y = z)) +
        stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", bins = 12, alpha = 0.6) +
        facet_wrap(~prepost, ncol = 2) +
        scale_fill_viridis_c(name = "density level") +
        coord_fixed() +
        scale_y_reverse() +
        labs(title = "Density (XZ)", x = "x", y = "y") +
        theme_bw() +
        theme(
          axis.text = element_blank(),
          axis.ticks = element_blank()
        )

      combined_density <- density_xy + density_xz

      combined_density

      ggsave(
        file.path(
          getwd(), "output.synapses.exploration", "density",
          paste0(path, "_", valence, "_", modality, "_most common neuron in path synapses.png")
        ),
        combined_density,
        width = 7, height = 7, dpi = 900, bg = "white"
      )
    }
  }
}
```

### 7.1 Excluding direct PPN1/vAB3 partners

Re-run the synapse-level summaries after removing strongest-path nodes that directly match PPN1 or vAB3 patterns.

```{r synapse-inspection-excluded}
for (modality in c("female.touch", "male.touch")) {
  for (path in c("PPN1", "vAB3")) {
    for (valence in c("excitatory", "inhibitory")) {
      comp1 <- modality
      comp2 <- path
      comp3 <- valence
      all.modalities %>%
        filter(modality == comp1) %>%
        filter(dataset == comp2) %>%
        filter(valence == comp3) %>%
        unnest_longer(nodes) %>%
        filter(!nodes %in% c(
          start.types.ppk25,
          start.types.ppk23,
          target.vAB3.all,
          target.PPN1.all
        )) %>%
        filter(!grepl("AN09B017", nodes)) %>%
        filter(!grepl("AN05B102", nodes)) %>%
        count(nodes, sort = TRUE) %>%
        mutate(n_frac = n / max(n)) -> a

      mba %>%
        select(type, superclass, bodyid) %>%
        filter(type %in% nodes & !grepl("sensory", superclass)) %>%
        left_join(a, by = c("type" = "nodes")) %>%
        filter(!is.na(n_frac)) -> aaa

      aaa <- aaa %>%
        arrange(desc(n_frac)) %>%
        filter(n_frac >= 0.3)


      syn_list <- lapply(aaa$bodyid, function(x) {
        neuprint_get_synapses(x) %>%
          mutate(prepost = as.factor(ifelse(prepost == 1, "input", "output")))
      })


      # assumes: syn_list (list of synapse dfs), aaa$bodyid (vector of bodyids), mba (optional)


      ids <- aaa$bodyid
      stopifnot(length(syn_list) == length(ids))

      # bind all synapses with bodyid (+ optional type)
      syn_all <- bind_rows(
        lapply(seq_along(syn_list), function(i) mutate(syn_list[[i]], bodyid = ids[i]))
      )
      if (exists("mba")) {
        syn_all <- syn_all %>% left_join(select(mba, bodyid, type), by = "bodyid")
      }

      syn_all <- syn_all %>%
        mutate(
          prepost = factor(prepost, levels = c("input", "output"))
        ) %>%
        left_join(aaa %>% distinct(type, .keep_all = TRUE) %>% select(type, n_frac), by = "type")

      base_theme <- theme_minimal() +
        theme(axis.text.x = element_blank(), axis.text.y = element_blank())


      # scatter plot
      p_xy <- ggplot(syn_all, aes(x = x, y = z, color = prepost, alpha = n_frac)) +
        geom_point(size = 0.1) +
        scale_color_manual(values = c(input = "blue", output = "red")) +
        scale_alpha_continuous(range = c(0.0001, 0.01)) +
        scale_y_reverse() +
        coord_fixed() +
        labs(title = "All synapses (XY)") +
        base_theme +
        guides(
          colour = guide_legend(override.aes = list(alpha = 1, size = 2)),
          alpha  = guide_legend(title = "n_frac")
        )

      p_xz <- ggplot(syn_all, aes(x = x, y = y, color = prepost, alpha = n_frac)) +
        geom_point(size = 0.1) +
        scale_color_manual(values = c(input = "blue", output = "red")) +
        scale_alpha_continuous(range = c(0.0001, 0.01)) +
        scale_y_reverse() +
        coord_fixed() +
        labs(title = "All synapses (XZ)") +
        base_theme +
        guides(
          colour = guide_legend(override.aes = list(alpha = 1, size = 2)),
          alpha  = guide_legend(title = "n_frac")
        )

      combined <- p_xy / p_xz + plot_layout(nrow = 2, heights = c(1, 1))
      g <- grid.grabExpr(print(combined))


      ggsave(
        file.path(
          getwd(), "output.synapses.exploration.wo.vAB3.and.PPN1", "scatter",
          paste0(path, "_", valence, "_", modality, "_most common neuron in path synapses.png")
        ),
        g,
        width = 7, height = 7, dpi = 900, bg = "white"
      )


      # heatmap


      # compute common limits
      common_limits <- range(
        ggplot_build(
          ggplot(syn_all, aes(x = x, y = y)) +
            stat_bin2d(bins = 100)
        )$data[[1]]$count,
        na.rm = TRUE
      )

      # define base heatmap function
      heat_map_xz <- function(df, title, show_legend = TRUE) {
        ggplot(df, aes(x = x, y = y)) +
          stat_bin2d(bins = 100, drop = TRUE) +
          scale_fill_viridis_c(
            name = "count",
            trans = "log10",
            limits = common_limits
          ) +
          coord_fixed() +
          scale_y_reverse() +
          labs(title = title, x = "x", y = "z") +
          theme_bw() +
          theme(
            legend.position = if (show_legend) "right" else "none",
            axis.text = element_blank(),
            axis.ticks = element_blank()
          )
      }

      heat_map_xy <- function(df, title, show_legend = TRUE) {
        ggplot(df, aes(x = x, y = z)) +
          stat_bin2d(bins = 150, drop = TRUE) +
          scale_fill_viridis_c(
            name = "count",
            trans = "log10",
            limits = common_limits
          ) +
          coord_fixed() +
          scale_y_reverse() +
          labs(title = title, x = "x", y = "y") +
          theme_bw() +
          theme(
            legend.position = if (show_legend) "right" else "none",
            axis.text = element_blank(),
            axis.ticks = element_blank()
          )
      }

      p_in <- heat_map_xz(filter(syn_all, prepost == "input"), "Input", FALSE)
      p_out <- heat_map_xz(filter(syn_all, prepost == "output"), "Output", FALSE)
      p_all <- heat_map_xz(syn_all, "All synapses", TRUE)
      p_in_xy <- heat_map_xy(filter(syn_all, prepost == "input"), "Input", FALSE)
      p_out_xy <- heat_map_xy(filter(syn_all, prepost == "output"), "Output", FALSE)
      p_all_xy <- heat_map_xy(syn_all, "All synapses", TRUE)



      # one legend only
      legend <- get_legend(p_all + theme(legend.position = "right"))
      p_in <- p_in + theme(legend.position = "none")
      p_out <- p_out + theme(legend.position = "none")
      p_all <- p_all + theme(legend.position = "none")
      p_in_xy <- p_in_xy + theme(legend.position = "none")
      p_out_xy <- p_out_xy + theme(legend.position = "none")
      p_all_xy <- p_all_xy + theme(legend.position = "none")

      r1 <- plot_grid(p_in, p_out, p_all, nrow = 1, rel_widths = c(1, 1, 1), align = "h", axis = "tb")
      r2 <- plot_grid(p_in_xy, p_out_xy, p_all_xy, nrow = 1, rel_widths = c(1.2, 1.2, 1.2), align = "h", axis = "tb")
      grid <- plot_grid(r1, r2, ncol = 1, rel_heights = c(1, 1))

      ggg <- plot_grid(grid, legend, ncol = 2, rel_widths = c(1, 0.12))

      ggsave(
        file.path(
          getwd(), "output.synapses.exploration.wo.vAB3.and.PPN1", "heatmap",
          paste0(path, "_", valence, "_", modality, "_most common neuron in path synapses.png")
        ),
        ggg,
        width = 7, height = 7, dpi = 900, bg = "white"
      )

      # Density

      density_xz <- ggplot(syn_all, aes(x = x, y = y)) +
        stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", bins = 12, alpha = 0.6) +
        facet_wrap(~prepost, ncol = 2) +
        scale_fill_viridis_c(name = "density level") +
        coord_fixed() +
        scale_y_reverse() +
        labs(title = "Density (XZ)", x = "x", y = "z") +
        theme_bw() +
        theme(
          axis.text = element_blank(),
          axis.ticks = element_blank()
        )

      density_xy <- ggplot(syn_all, aes(x = x, y = z)) +
        stat_density_2d(aes(fill = after_stat(level)), geom = "polygon", bins = 12, alpha = 0.6) +
        facet_wrap(~prepost, ncol = 2) +
        scale_fill_viridis_c(name = "density level") +
        coord_fixed() +
        scale_y_reverse() +
        labs(title = "Density (XZ)", x = "x", y = "y") +
        theme_bw() +
        theme(
          axis.text = element_blank(),
          axis.ticks = element_blank()
        )

      combined_density <- density_xy + density_xz

      combined_density

      ggsave(
        file.path(
          getwd(), "output.synapses.exploration.wo.vAB3.and.PPN1", "density",
          paste0(path, "_", valence, "_", modality, "_most common neuron in path synapses.png")
        ),
        combined_density,
        width = 7, height = 7, dpi = 900, bg = "white"
      )
    }
  }
}
```
