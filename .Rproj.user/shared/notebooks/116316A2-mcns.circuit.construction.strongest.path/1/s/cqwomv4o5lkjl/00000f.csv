"0","calculate_normed_adj_matrix <-function(connectivity,cell.or.type='type',pre.or.post='pre'){"
"0","  colScale <- function(A, na.rm = TRUE) {"
"0","    scalefac <- 1 / Matrix::colSums(A)"
"0","    if (na.rm) scalefac[!is.finite(scalefac)] <- 0"
"0","    B <- A %*% Matrix::Diagonal(x = scalefac)"
"0","    B"
"0","    }"
"0","  rowScale <- function(A, na.rm = TRUE) {"
"0","    scalefac <- 1 / Matrix::rowSums(A)"
"0","    if (na.rm) scalefac[!is.finite(scalefac)] <- 0"
"0","    B <- Matrix::Diagonal(x = scalefac) %*% A"
"0","    B"
"0","    }"
"0","  if(cell.or.type=='cell'){"
"0","    unique.identifier <- union(as.character(connectivity$pre_id), as.character(connectivity$post_id))"
"0","    adj.matrix <- sparseMatrix("
"0","      i = match(connectivity$pre_id, unique.identifier),"
"0","      j = match(connectivity$post_id, unique.identifier),"
"0","      x = connectivity$weight,"
"0","      dims = c(length(unique.identifier), length(unique.identifier)),"
"0","      dimnames = list(unique.identifier, unique.identifier))"
"0","  }else{"
"0","    unique.identifier <- union(connectivity$pre_type, connectivity$post_type)"
"0","    adj.matrix <- sparseMatrix("
"0","      i = match(connectivity$pre_type, unique.identifier),"
"0","      j = match(connectivity$post_type, unique.identifier),"
"0","      x = connectivity$weight,"
"0","      dims = c(length(unique.identifier), length(unique.identifier)),"
"0","      dimnames = list(unique.identifier, unique.identifier))"
"0","  }"
"0","  if(pre.or.post=='pre'){"
"0","    adj.matrix.normed.pre <- rowScale(adj.matrix)"
"0","    colnames(adj.matrix.normed.pre) <- colnames(adj.matrix)"
"0","    rownames(adj.matrix.normed.pre) <- rownames(adj.matrix)"
"0","    return(adj.matrix.normed.pre)"
"0","  }else if(pre.or.post=='avg'){"
"0","    adj.matrix.normed.post <- colScale(adj.matrix)"
"0","    colnames(adj.matrix.normed.post) <- colnames(adj.matrix)"
"0","    rownames(adj.matrix.normed.post) <- rownames(adj.matrix)"
"0","    adj.matrix.normed.pre <- rowScale(adj.matrix)"
"0","    colnames(adj.matrix.normed.pre) <- colnames(adj.matrix)"
"0","    rownames(adj.matrix.normed.pre) <- rownames(adj.matrix)"
"0","    "
"0","    return(avg_mat <- (adj.matrix.normed.post + adj.matrix.normed.post) / 2)"
"0","    "
"0","  }"
"0","  "
"0","  else{"
"0","    adj.matrix.normed.post <- colScale(adj.matrix)"
"0","    colnames(adj.matrix.normed.post) <- colnames(adj.matrix)"
"0","    rownames(adj.matrix.normed.post) <- rownames(adj.matrix)"
"0","    return(adj.matrix.normed.post)"
"0","  }"
"0","}"
